<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>26&nbsp; Guiding Center – Key Notes in Plasma Physics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../contents/cr.html" rel="next">
<link href="../contents/aurora.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-0dd2bd5de344125cf763a379ddc3eb04.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-2f0f3f814df0dbcf15d9db12df35466a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-0dd2bd5de344125cf763a379ddc3eb04.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../contents/gc.html"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Guiding Center</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Key Notes in Plasma Physics</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/henry2004y/KeyNotes/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">About</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/math.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Math</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/theoretical_mechanics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Theoretical Mechanics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/relativity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Relativity</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/unit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Unit Conversion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/single.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Single-Particle Motions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/fluid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plasmas as Fluid</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/diffres.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Diffusion and Resisvity</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/wave.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Waves</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/emhd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">EMHD</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/kinetic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Kinetic Theory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/stability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Stability</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/kmhd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Kinetic MHD</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/gyrokinetics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Gyrokinetics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/flr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Field Line Resonance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/nonlinear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Nonlinear Effects</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/turbulence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Turbulence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/geometry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Geometry</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/solarwind.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Solar Wind</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/shock.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Shock</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/magnetosphere.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Magnetosphere</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/ionosphere.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Ionosphere</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/radiationbelt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Radiation Belt</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/aurora.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Aurora</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/gc.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Guiding Center</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/cr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Cosmic Ray</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/boundary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Boundary Conditions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/pic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Particle-in-Cell</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/hybrid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Hybrid Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/raytracing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Ray Tracing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Tests</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/inductance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Inductance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/capacitance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Capacitance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#summarized-version" id="toc-summarized-version" class="nav-link active" data-scroll-target="#summarized-version"><span class="header-section-number">26.1</span> Summarized Version</a>
  <ul class="collapse">
  <li><a href="#basic-concepts-and-variables" id="toc-basic-concepts-and-variables" class="nav-link" data-scroll-target="#basic-concepts-and-variables"><span class="header-section-number">26.1.1</span> Basic Concepts and Variables</a></li>
  <li><a href="#the-effective-fields" id="toc-the-effective-fields" class="nav-link" data-scroll-target="#the-effective-fields"><span class="header-section-number">26.1.2</span> The Effective Fields</a></li>
  <li><a href="#hamiltonian" id="toc-hamiltonian" class="nav-link" data-scroll-target="#hamiltonian"><span class="header-section-number">26.1.3</span> Hamiltonian</a></li>
  <li><a href="#equations-of-motion" id="toc-equations-of-motion" class="nav-link" data-scroll-target="#equations-of-motion"><span class="header-section-number">26.1.4</span> Equations of Motion</a></li>
  <li><a href="#numerical-implementation-guide" id="toc-numerical-implementation-guide" class="nav-link" data-scroll-target="#numerical-implementation-guide"><span class="header-section-number">26.1.5</span> Numerical Implementation Guide</a></li>
  <li><a href="#conversion-from-full-phase-space-to-guiding-center" id="toc-conversion-from-full-phase-space-to-guiding-center" class="nav-link" data-scroll-target="#conversion-from-full-phase-space-to-guiding-center"><span class="header-section-number">26.1.6</span> Conversion from Full Phase Space to Guiding Center</a></li>
  <li><a href="#conversion-from-guiding-center-to-full-phase-space" id="toc-conversion-from-guiding-center-to-full-phase-space" class="nav-link" data-scroll-target="#conversion-from-guiding-center-to-full-phase-space"><span class="header-section-number">26.1.7</span> Conversion from Guiding Center to Full Phase Space</a></li>
  </ul></li>
  <li><a href="#classical-guiding-center-theory" id="toc-classical-guiding-center-theory" class="nav-link" data-scroll-target="#classical-guiding-center-theory"><span class="header-section-number">26.2</span> Classical Guiding Center Theory</a>
  <ul class="collapse">
  <li><a href="#lorentz-equation-in-tensor-form" id="toc-lorentz-equation-in-tensor-form" class="nav-link" data-scroll-target="#lorentz-equation-in-tensor-form"><span class="header-section-number">26.2.1</span> Lorentz equation in tensor form</a></li>
  <li><a href="#fundamental-assumptions" id="toc-fundamental-assumptions" class="nav-link" data-scroll-target="#fundamental-assumptions"><span class="header-section-number">26.2.2</span> Fundamental assumptions</a></li>
  <li><a href="#derivations-of-gc-equation" id="toc-derivations-of-gc-equation" class="nav-link" data-scroll-target="#derivations-of-gc-equation"><span class="header-section-number">26.2.3</span> Derivations of GC equation</a></li>
  <li><a href="#first-order-solution-for-the-gca-equations-of-motion" id="toc-first-order-solution-for-the-gca-equations-of-motion" class="nav-link" data-scroll-target="#first-order-solution-for-the-gca-equations-of-motion"><span class="header-section-number">26.2.4</span> First order solution for the GCA equations of motion</a></li>
  <li><a href="#recursive-solution" id="toc-recursive-solution" class="nav-link" data-scroll-target="#recursive-solution"><span class="header-section-number">26.2.5</span> Recursive solution</a></li>
  <li><a href="#energy-conservation" id="toc-energy-conservation" class="nav-link" data-scroll-target="#energy-conservation"><span class="header-section-number">26.2.6</span> Energy conservation</a></li>
  </ul></li>
  <li><a href="#validity-and-higher-order-corrections" id="toc-validity-and-higher-order-corrections" class="nav-link" data-scroll-target="#validity-and-higher-order-corrections"><span class="header-section-number">26.3</span> Validity and Higher-Order Corrections</a>
  <ul class="collapse">
  <li><a href="#numerical-implementation" id="toc-numerical-implementation" class="nav-link" data-scroll-target="#numerical-implementation"><span class="header-section-number">26.3.1</span> Numerical implementation</a></li>
  <li><a href="#nonrelativistic-case" id="toc-nonrelativistic-case" class="nav-link" data-scroll-target="#nonrelativistic-case"><span class="header-section-number">26.3.2</span> Nonrelativistic case</a></li>
  </ul></li>
  <li><a href="#hamiltonian-theory-of-guiding-center-motion" id="toc-hamiltonian-theory-of-guiding-center-motion" class="nav-link" data-scroll-target="#hamiltonian-theory-of-guiding-center-motion"><span class="header-section-number">26.4</span> Hamiltonian Theory of Guiding Center Motion</a>
  <ul class="collapse">
  <li><a href="#noncanonical-hamiltonian-guiding-center-theory" id="toc-noncanonical-hamiltonian-guiding-center-theory" class="nav-link" data-scroll-target="#noncanonical-hamiltonian-guiding-center-theory"><span class="header-section-number">26.4.1</span> Noncanonical Hamiltonian guiding center theory</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/henry2004y/KeyNotes/edit/master/contents/gc.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-GC" class="quarto-section-identifier"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Guiding Center</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The guiding center approximation (GCA) is a theoretical framework used to simplify the complex motion of charged particles in electromagnetic fields by separating the fast gyromotion from the slower drifts of the particle’s guiding center (GC).</p>
<p>The basic equation governing the motion of a charged particle with mass m and charge e is given by <span class="math display">\[
\frac{\mathrm{d}\mathbf{u}}{\mathrm{d}t} = \frac{e}{mc}\left( c\mathbf{E} + \mathbf{v}\times\mathbf{B} \right)
\]</span> where <span class="math inline">\(\mathbf{u}=\gamma\mathbf{v}\)</span> represents the particle’s four-velocity, <span class="math inline">\(\mathbf{v}\)</span> is the particle velocity, c is the speed of light while <span class="math inline">\(\mathbf{E}\)</span> and <span class="math inline">\(\mathbf{B}\)</span> are the electric and magnetic field vectors, respectively.</p>
<p>In GCA, the orbital motion of the particle is detached from its instantaneous gyration center. This relaxes any constraints related to particle gyration, allowing systematic larger time steps to be taken and thus a considerable saving in computational time. The guiding center (GC) equations are obtained in the limit of slow-varying fields. This restricts its validity to situations in which the Larmor radius remains negligible with respect to the overall electromagnetic field scale and in which the cyclotron frequency is large enough so that adiabatic invariance holds. In this respect, the GCA is most suitable for particles with large charge-to-mass ratios such as electrons.</p>
<section id="summarized-version" class="level2" data-number="26.1">
<h2 data-number="26.1" class="anchored" data-anchor-id="summarized-version"><span class="header-section-number">26.1</span> Summarized Version</h2>
<section id="basic-concepts-and-variables" class="level3" data-number="26.1.1">
<h3 data-number="26.1.1" class="anchored" data-anchor-id="basic-concepts-and-variables"><span class="header-section-number">26.1.1</span> Basic Concepts and Variables</h3>
<p><strong>State Variables</strong>: Instead of the full 6D phase space <span class="math inline">\((\mathbf{x}, \mathbf{v})\)</span>, we solve for the reduced 4D guiding center state:</p>
<ul>
<li><span class="math inline">\(\mathbf{X}\)</span>: The spatial position of the guiding center.</li>
<li><span class="math inline">\(p_{\parallel} = m \gamma v_{\parallel}\)</span>: The relativistic kinetic momentum parallel to the magnetic field, where <span class="math inline">\(\gamma\)</span> is the Lorentz factor.</li>
</ul>
<p>The position <span class="math inline">\(\mathbf{r}\)</span> of a particle is decomposed into the guiding center position <span class="math inline">\(\mathbf{R}(t)\)</span> and the gyration vector <span class="math inline">\(\boldsymbol{\rho}\)</span>: <span class="math display">\[
\mathbf{r} = \mathbf{R}(t) + \boldsymbol{\rho}(\mathbf{R}, t, \psi)
\]</span> where <span class="math inline">\(\psi\)</span> is the gyrophase. This approximation holds when the characteristic scale of field variations <span class="math inline">\(L\)</span> is much larger than the Larmor radius <span class="math inline">\(\rho\)</span> (<span class="math inline">\(L \gg \rho\)</span>) and time variations are slow compared to the gyroperiod.</p>
<p><strong>Parameters (Constant of Motion)</strong>:</p>
<ul>
<li><span class="math inline">\(\mu\)</span>: The magnetic moment (adiabatic invariant). <span class="math display">\[
\mu = \frac{p_{\perp}^2}{2mB}
\]</span> In the GCA, <span class="math inline">\(\mu\)</span> is constant. It is calculated once from the initial conditions and treated as a parameter during the simulation.</li>
</ul>
</section>
<section id="the-effective-fields" class="level3" data-number="26.1.2">
<h3 data-number="26.1.2" class="anchored" data-anchor-id="the-effective-fields"><span class="header-section-number">26.1.2</span> The Effective Fields</h3>
<p>The modern GCA equations can be written compactly using “effective” electromagnetic fields <span class="math inline">\(\mathbf{B}^*\)</span> and <span class="math inline">\(\mathbf{E}^*\)</span>. These correct the standard fields to account for drifts naturally.</p>
<p>Definitions:</p>
<ul>
<li><span class="math inline">\(\mathbf{B}(\mathbf{X})\)</span> and <span class="math inline">\(\mathbf{E}(\mathbf{X})\)</span>: Standard EM fields at the guiding center location.</li>
<li><span class="math inline">\(\mathbf{b} = \mathbf{B}/|\mathbf{B}|\)</span>: Unit vector along the magnetic field line.</li>
<li><span class="math inline">\(q\)</span>: Particle charge.</li>
</ul>
<p><strong>Calculate the Effective Magnetic Field <span class="math inline">\(\mathbf{B}^*\)</span></strong></p>
<p>This term incorporates the geometry of the field lines (curl of <span class="math inline">\(\mathbf{b}\)</span>) which drives curvature drift. <span class="math display">\[
\mathbf{B}^* = \mathbf{B} + \frac{c p_{\parallel}}{q} \nabla \times \mathbf{b}
\]</span></p>
<p><strong>Calculate the Effective Electric Field <span class="math inline">\(\mathbf{E}^*\)</span></strong></p>
<p>In many implementations, it is easier to work directly with the Hamiltonian gradients, but formally: <span class="math display">\[
\mathbf{E}^* = \mathbf{E} - \frac{1}{q} \nabla ( \mu B )
\]</span></p>
</section>
<section id="hamiltonian" class="level3" data-number="26.1.3">
<h3 data-number="26.1.3" class="anchored" data-anchor-id="hamiltonian"><span class="header-section-number">26.1.3</span> Hamiltonian</h3>
<p>For a relativistic particle, the Hamiltonian <span class="math inline">\(H\)</span> represents the total energy. <span class="math display">\[
H(\mathbf{X}, p_{\parallel}, \mu, t) = \sqrt{m^2 c^4 + p_{\parallel}^2 c^2 + 2 m \mu B(\mathbf{X}) c^2} + q \Phi(\mathbf{X})
\]</span></p>
<ul>
<li><span class="math inline">\(\Phi\)</span>: Electric scalar potential (if <span class="math inline">\(\mathbf{E} = -\nabla \Phi\)</span>).</li>
<li>Note: If you only have <span class="math inline">\(\mathbf{E}\)</span> and not <span class="math inline">\(\Phi\)</span>, you will use the force term <span class="math inline">\(q E_{\parallel}\)</span> directly in the equations of motion.</li>
</ul>
</section>
<section id="equations-of-motion" class="level3" data-number="26.1.4">
<h3 data-number="26.1.4" class="anchored" data-anchor-id="equations-of-motion"><span class="header-section-number">26.1.4</span> Equations of Motion</h3>
<p>These are the final expressions to solve numerically. They describe the time evolution of the guiding center position <span class="math inline">\(\mathbf{X}\)</span> and parallel momentum <span class="math inline">\(p_{\parallel}\)</span>.</p>
<p>Equation for Position (<span class="math inline">\(\dot{\mathbf{X}}\)</span>): <span class="math display">\[
\frac{d\mathbf{X}}{dt} = \frac{1}{B^*_{\parallel}} \left[ \frac{p_{\parallel}}{m \gamma} \mathbf{B}^* + c \mathbf{E}^* \times \mathbf{b} \right]
\]</span></p>
<ul>
<li>Term 1 (<span class="math inline">\(\propto \mathbf{B}^\ast\)</span>): Represents motion along the field line plus curvature drift (hidden inside <span class="math inline">\(\mathbf{B}^\ast\)</span>).</li>
<li>Term 2 (<span class="math inline">\(\propto \mathbf{E}^\ast \times \mathbf{b}\)</span>): Represents the <span class="math inline">\(\mathbf{E} \times \mathbf{B}\)</span> drift and the <span class="math inline">\(\nabla B\)</span> drift (hidden inside <span class="math inline">\(\mathbf{E}^\ast\)</span> via the <span class="math inline">\(\mu \nabla B\)</span> term).</li>
<li>Denominator: <span class="math inline">\(B^\ast_{\parallel} = \mathbf{b} \cdot \mathbf{B}^\ast \approx B\)</span>. This is a normalization factor essentially equal to <span class="math inline">\(B\)</span> but corrected for phase-space volume conservation.</li>
</ul>
<p>Equation for Parallel Momentum (<span class="math inline">\(\dot{p}_{\parallel}\)</span>): <span class="math display">\[
\frac{dp_{\parallel}}{dt} = \frac{q}{B^\ast_{\parallel}} \mathbf{B}^* \cdot \mathbf{E}^\ast
\]</span></p>
<p>This simplifies to the standard parallel force equation: <span class="math display">\[
\dot{p}_{\parallel} \approx q E_{\parallel} - \frac{\mu}{\gamma} \nabla_{\parallel} B
\]</span></p>
</section>
<section id="numerical-implementation-guide" class="level3" data-number="26.1.5">
<h3 data-number="26.1.5" class="anchored" data-anchor-id="numerical-implementation-guide"><span class="header-section-number">26.1.5</span> Numerical Implementation Guide</h3>
<p>To implement this in code, follow this loop:</p>
<ul>
<li>A. Initialization
<ol type="1">
<li>Start with particle particle position <span class="math inline">\(\mathbf{x}\)</span> and velocity <span class="math inline">\(\mathbf{v}\)</span>.</li>
<li>Compute local <span class="math inline">\(\mathbf{B}(\mathbf{x})\)</span> and <span class="math inline">\(\mathbf{b}\)</span>.</li>
<li>Decompose velocity: <span class="math inline">\(\mathbf{v} = v_{\parallel} \mathbf{b} + \mathbf{v}_{\perp}\)</span>.</li>
<li>Compute <span class="math inline">\(\mu = \frac{m \gamma^2 v_{\perp}^2}{2 B}\)</span> (Relativistic moment).</li>
<li>Initialize state vector <span class="math inline">\(\mathbf{Y} = [\mathbf{X}, p_{\parallel}]\)</span>.</li>
</ol></li>
<li>B. Time Stepping Loop. For every time step <span class="math inline">\(t \to t + \Delta t\)</span>:
<ol type="1">
<li>Interpolate Fields: Get <span class="math inline">\(\mathbf{B}, \mathbf{E}, \nabla \mathbf{B}\)</span> at current <span class="math inline">\(\mathbf{X}\)</span>.</li>
<li>Compute Gradients: You need <span class="math inline">\(\nabla \times \mathbf{b}\)</span> and <span class="math inline">\(\nabla B\)</span>.</li>
</ol>
<ul>
<li><span class="math inline">\(\nabla \times \mathbf{b}\)</span> can be computed numerically or analytically if the B-field model is known.</li>
</ul>
<ol start="3" type="1">
<li>Construct Effective Fields:</li>
</ol>
<ul>
<li><span class="math inline">\(\mathbf{B}^* = \mathbf{B} + \frac{c p_{\parallel}}{q} (\nabla \times \mathbf{b})\)</span></li>
<li><span class="math inline">\(B^*_{\parallel} = \mathbf{b} \cdot \mathbf{B}^*\)</span></li>
</ul>
<ol start="4" type="1">
<li>Evaluate Derivatives (RHS):</li>
</ol>
<ul>
<li><span class="math inline">\(\gamma = \sqrt{1 + \frac{p_{\parallel}^2 + 2m\mu B}{m^2 c^2}}\)</span></li>
<li><span class="math inline">\(\dot{\mathbf{X}} = \frac{1}{B^*_{\parallel}} \left( \frac{p_{\parallel}}{m \gamma} \mathbf{B}^* + \frac{c}{q} (q\mathbf{E} - \mu \nabla B) \times \mathbf{b} \right)\)</span></li>
<li><span class="math inline">\(\dot{p}_{\parallel} = \frac{q}{B^*_{\parallel}} \mathbf{B}^* \cdot \left( \mathbf{E} - \frac{\mu}{q} \nabla B \right)\)</span></li>
</ul>
<ol start="5" type="1">
<li>Advance: Update <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(p_{\parallel}\)</span>.</li>
</ol></li>
<li>C. Constraints &amp; Checks
<ul>
<li>Time Step: The GCA allows much larger time steps than full orbit codes because you don’t resolve the gyro-period. However, you must resolve the gradient length scales. A common constraint is ensuring the particle does not cross more than one cell (or characteristic length) per step.</li>
<li>Validity: Check that <span class="math inline">\(E_{\perp} &lt; B\)</span> and that the gyroradius is small compared to field gradients (<span class="math inline">\(R_L \ll L_B\)</span>).</li>
</ul></li>
</ul>
</section>
<section id="conversion-from-full-phase-space-to-guiding-center" class="level3" data-number="26.1.6">
<h3 data-number="26.1.6" class="anchored" data-anchor-id="conversion-from-full-phase-space-to-guiding-center"><span class="header-section-number">26.1.6</span> Conversion from Full Phase Space to Guiding Center</h3>
<p>Transforming from the full 6D particle state <span class="math inline">\((\mathbf{x}, \mathbf{v})\)</span> to the reduced Guiding Center (GC) state <span class="math inline">\((\mathbf{X}, v_{\parallel}, \mu)\)</span> is a surjective mapping (many particle states map to the same GC state).</p>
<p>To perform this switch consistently—especially in hybrid codes where you might switch back and forth—it is critical to match the constants of motion (like Energy) between the two frames. Here is the step-by-step transformation procedure:</p>
<ol type="1">
<li>Calculate the Guiding Center Position (<span class="math inline">\(\mathbf{X}\)</span>)</li>
</ol>
<p>The guiding center is located at the center of the particle’s gyration. You must calculate the Larmor radius vector at the particle’s current position <span class="math inline">\(\mathbf{x}\)</span> and subtract it.</p>
<ul>
<li>Compute local field: Retrieve <span class="math inline">\(\mathbf{B}(\mathbf{x})\)</span> and the unit vector <span class="math inline">\(\mathbf{b}(\mathbf{x}) = \mathbf{B}(\mathbf{x}) / |\mathbf{B}(\mathbf{x})|\)</span>.</li>
<li>Compute displacement: <span class="math display">\[
\mathbf{X} \approx \mathbf{x} + \frac{m}{q B(\mathbf{x})} \mathbf{v} \times \mathbf{b}(\mathbf{x})
\]</span>
<ul>
<li>This equation is valid to the first order in the Larmor radius.</li>
<li>It is recommended to perform this displacement in Cartesian coordinates to avoid singularities.</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li>Update Fields at the New Position</li>
</ol>
<p>Once you have the estimated guiding center position <span class="math inline">\(\mathbf{X}\)</span>, you must evaluate the electromagnetic fields <span class="math inline">\(\mathbf{B}(\mathbf{X})\)</span>, <span class="math inline">\(\mathbf{E}(\mathbf{X})\)</span> and potentials <span class="math inline">\(\Phi(\mathbf{X})\)</span> at this new location.</p>
<ol start="3" type="1">
<li>Calculate Parallel Velocity (<span class="math inline">\(v_{\parallel}\)</span>)</li>
</ol>
<p>The parallel velocity is defined relative to the magnetic field at the guiding center <span class="math inline">\(\mathbf{X}\)</span>, not the particle position <span class="math inline">\(\mathbf{x}\)</span>.</p>
<ul>
<li>Standard Projection: <span class="math display">\[
v_{\parallel} = \mathbf{v} \cdot \mathbf{b}(\mathbf{X})
\]</span></li>
<li>Energy/Momentum Matching (High Precision): For higher accuracy, specifically to ensure that the particle’s toroidal momentum <span class="math inline">\(P_{\phi}\)</span> is conserved during the switch (in axisymmetric systems), you can calculate <span class="math inline">\(v_{\parallel}\)</span> derived from the momentum conservation equation: <span class="math display">\[
v_{\parallel} \approx \frac{1}{B(\mathbf{X})} \left( \mathbf{v} \cdot \mathbf{B}(\mathbf{X}) + \dots \text{higher order terms} \right)
\]</span></li>
</ul>
<p>For most standard implementations, the simple projection <span class="math inline">\(\mathbf{v} \cdot \mathbf{b}(\mathbf{X})\)</span> is sufficient.</p>
<ol start="4" type="1">
<li>Calculate Magnetic Moment (<span class="math inline">\(\mu\)</span>)</li>
</ol>
<p>The magnetic moment is the adiabatic invariant. It is crucial to calculate <span class="math inline">\(\mu\)</span> such that the total energy <span class="math inline">\(\mathcal{H}\)</span> of the particle is conserved during the transformation.</p>
<ul>
<li>Energy Conservation Condition: <span class="math display">\[
\mathcal{H}_{\text{particle}} = \mathcal{H}_{\text{GC}}
\]</span> <span class="math display">\[
\frac{1}{2} m v^2 + q \Phi(\mathbf{x}) = \frac{1}{2} m v_{\parallel}^2 + \mu B(\mathbf{X}) + q \Phi(\mathbf{X})
\]</span></li>
<li>Formula for <span class="math inline">\(\mu\)</span>: Rearranging the energy equation gives the most robust definition for <span class="math inline">\(\mu\)</span> during the switch: <span class="math display">\[\mu = \frac{1}{B(\mathbf{X})} \left[ \frac{1}{2} m v^2 - \frac{1}{2} m v_{\parallel}^2 + q(\Phi(\mathbf{x}) - \Phi(\mathbf{X})) \right]\]</span>
<ul>
<li>If the electric potential variation <span class="math inline">\(q(\Phi(\mathbf{x}) - \Phi(\mathbf{X}))\)</span> is negligible (order of Larmor radius), this simplifies to the standard definition: <span class="math display">\[
\mu \approx \frac{m v_{\perp}^2}{2 B(\mathbf{X})}
\]</span> where <span class="math inline">\(v_{\perp}^2 = v^2 - v_{\parallel}^2\)</span>.</li>
</ul></li>
</ul>
<p>Summary Algorithm 1. Input: Particle <span class="math inline">\(\mathbf{x}, \mathbf{v}\)</span>. 2. Shift: <span class="math inline">\(\mathbf{X} = \mathbf{x} + \frac{m}{q B(\mathbf{x})} (\mathbf{v} \times \mathbf{b})\)</span>. 3. Project: <span class="math inline">\(v_{\parallel} = \mathbf{v} \cdot \mathbf{b}(\mathbf{X})\)</span>. 4. Conserve: <span class="math inline">\(\mu = \frac{ \frac{1}{2}m v^2 - \frac{1}{2}m v_{\parallel}^2 }{B(\mathbf{X})}\)</span> (ignoring potential differences). 5. Output: State <span class="math inline">\((\mathbf{X}, v_{\parallel}, \mu)\)</span>.</p>
</section>
<section id="conversion-from-guiding-center-to-full-phase-space" class="level3" data-number="26.1.7">
<h3 data-number="26.1.7" class="anchored" data-anchor-id="conversion-from-guiding-center-to-full-phase-space"><span class="header-section-number">26.1.7</span> Conversion from Guiding Center to Full Phase Space</h3>
<p>Converting from the reduced Guiding Center (GC) variables <span class="math inline">\((\mathbf{X}, p_{\parallel}, \mu)\)</span> back to the full 6D particle phase space <span class="math inline">\((\mathbf{x}, \mathbf{p})\)</span> is a “one-to-many” mapping. Because the gyrophase <span class="math inline">\(\zeta\)</span> is averaged out in the GCA, you must arbitrarily choose (or randomly assign) a gyrophase angle <span class="math inline">\(\zeta \in [0, 2\pi)\)</span> to reconstruct a specific particle position and velocity.</p>
<p>Here is the step-by-step reconstruction procedure.</p>
<ol type="1">
<li>Calculate Local Quantities at the Guiding Center</li>
</ol>
<p>First, evaluate the electromagnetic fields and unit vectors at the known guiding center position <span class="math inline">\(\mathbf{X}\)</span>. - Local Magnetic Field: <span class="math inline">\(\mathbf{B} = \mathbf{B}(\mathbf{X})\)</span> - Unit Vector: <span class="math inline">\(\mathbf{b} = \mathbf{B} / |\mathbf{B}|\)</span> - Perpendicular Momentum Magnitude: Calculate <span class="math inline">\(p_{\perp}\)</span> from the magnetic moment <span class="math inline">\(\mu\)</span> (which is a parameter in GCA): <span class="math display">\[
p_{\perp} = \sqrt{2 m B(\mathbf{X}) \mu}
\]</span> - Gyroradius Magnitude: <span class="math display">\[
\rho = \frac{p_{\perp}}{|q| B(\mathbf{X})}
\]</span></p>
<ol start="2" type="1">
<li>Define a Perpendicular Basis</li>
</ol>
<p>To define the gyration direction, you need a coordinate system perpendicular to the magnetic field. Construct two unit vectors <span class="math inline">\(\mathbf{e}_1\)</span> and <span class="math inline">\(\mathbf{e}_2\)</span> such that <span class="math inline">\((\mathbf{e}_1, \mathbf{e}_2, \mathbf{b})\)</span> form a right-handed orthonormal basis.</p>
<p>A common numerical method to find <span class="math inline">\(\mathbf{e}_1\)</span> is: <span class="math display">\[
\mathbf{e}_1 = \frac{\mathbf{b} \times \hat{\mathbf{u}}}{|\mathbf{b} \times \hat{\mathbf{u}}|}
\]</span> where <span class="math inline">\(\hat{\mathbf{u}}\)</span> is any fixed unit vector not parallel to <span class="math inline">\(\mathbf{b}\)</span>, e.g., <span class="math inline">\(\hat{\mathbf{x}}\)</span>. Then: <span class="math display">\[
\mathbf{e}_2 = \mathbf{b} \times \mathbf{e}_1
\]</span></p>
<ol start="3" type="1">
<li>Reconstruct Particle Position (<span class="math inline">\(\mathbf{x}\)</span>)</li>
</ol>
<p>The particle position is the guiding center position displaced by the Larmor radius vector <span class="math inline">\(\boldsymbol{\rho}\)</span>. Select a gyrophase <span class="math inline">\(\zeta\)</span> (e.g., draw from a uniform distribution <span class="math inline">\(U[0, 2\pi]\)</span>). <span class="math display">\[
\mathbf{x} = \mathbf{X} + \boldsymbol{\rho}
\]</span></p>
<p>The displacement vector <span class="math inline">\(\boldsymbol{\rho}\)</span> is: <span class="math display">\[
\boldsymbol{\rho} = \rho (\cos\zeta \, \mathbf{e}_1 + \sin\zeta \, \mathbf{e}_2)
\]</span></p>
<p>Note: In some high-precision hybrid schemes, specific choices for <span class="math inline">\(\zeta\)</span> (such as aligning <span class="math inline">\(\boldsymbol{\rho}\)</span> perpendicular to <span class="math inline">\(\nabla B\)</span>) are used to minimize energy discrepancies when switching models, but for general reconstruction, a random phase is standard.</p>
<ol start="4" type="1">
<li>Reconstruct Particle Momentum (<span class="math inline">\(\mathbf{p}\)</span>)</li>
</ol>
<p>The total momentum is the sum of the parallel momentum, the perpendicular gyration momentum, and (optionally for higher accuracy) the momentum associated with the <span class="math inline">\(\mathbf{E} \times \mathbf{B}\)</span> drift.</p>
<p><strong>Standard Reconstruction (0th Order)</strong>: This reconstruction creates a particle purely gyrating and moving parallel to field lines. <span class="math display">\[
\mathbf{p} = p_{\parallel} \mathbf{b} + \mathbf{p}_{gyro}
\]</span> where the gyration momentum <span class="math inline">\(\mathbf{p}_{gyro}\)</span> is perpendicular to <span class="math inline">\(\boldsymbol{\rho}\)</span> (tangent to the circle): <span class="math display">\[
\mathbf{p}_{gyro} = p_{\perp} (-\sin\zeta \, \mathbf{e}_1 + \cos\zeta \, \mathbf{e}_2) \times \text{sign}(q)
\]</span></p>
<p><strong>Drift-Corrected Reconstruction (1st Order)</strong>: If the GCA simulation includes significant <span class="math inline">\(\mathbf{E} \times \mathbf{B}\)</span> drifts, we should add this component to the particle velocity to ensure the full orbit matches the drift path. <span class="math display">\[
\mathbf{p} \approx p_{\parallel} \mathbf{b} + \mathbf{p}_{gyro} + m \gamma \mathbf{v}_E
\]</span> where <span class="math display">\[
\mathbf{v}_E = \frac{c \mathbf{E} \times \mathbf{b}}{B}
\]</span></p>
</section>
</section>
<section id="classical-guiding-center-theory" class="level2" data-number="26.2">
<h2 data-number="26.2" class="anchored" data-anchor-id="classical-guiding-center-theory"><span class="header-section-number">26.2</span> Classical Guiding Center Theory</h2>
<p>Here are the essentials points in the derivation of the classical <em>guiding center equations of motion (EOM)</em>. For a complete discussion refer to <span class="citation" data-cites="vandervoort1960relativistic">Vandervoort (<a href="#ref-vandervoort1960relativistic" role="doc-biblioref">1960</a>)</span>.</p>
<section id="lorentz-equation-in-tensor-form" class="level3" data-number="26.2.1">
<h3 data-number="26.2.1" class="anchored" data-anchor-id="lorentz-equation-in-tensor-form"><span class="header-section-number">26.2.1</span> Lorentz equation in tensor form</h3>
<p>In order to derive the Guiding Center Approximation (GCA), we would use the tensor notations in relativity. The equation of motion for a charged particle in an EM field are written in a tensorial form as <span id="eq-charged-particle-motion-general"><span class="math display">\[
\frac{\mathrm{d}x_\mu}{\mathrm{d}\tau^2} = F_{\mu\nu} \frac{\mathrm{d}x_\nu}{\mathrm{d}\tau}
\tag{26.1}\]</span></span> where <span class="math inline">\(x_\mu\)</span> is the particle four-coordinate, <span class="math inline">\(F_{\mu\nu}\)</span> is the EM tensor and <span class="math inline">\(\tau\)</span> is the particle proper time.</p>
<p>The EM tensor is <span id="eq-em-tensor"><span class="math display">\[
F_{\mu\nu} = \frac{e}{mc}
\begin{pmatrix}
0 &amp; B_z &amp; -B_y &amp; E_x \\
-B_z &amp; 0 &amp; B_x &amp; E_y \\
B_y &amp; -B_x &amp; 0 &amp; E_z \\
E_x &amp; E_y &amp; E_z &amp; 0
\end{pmatrix}
\tag{26.2}\]</span></span></p>
</section>
<section id="fundamental-assumptions" class="level3" data-number="26.2.2">
<h3 data-number="26.2.2" class="anchored" data-anchor-id="fundamental-assumptions"><span class="header-section-number">26.2.2</span> Fundamental assumptions</h3>
<p>The GC formalism holds under two fundamental assumptions, namely:</p>
<ol type="1">
<li>The gyration radius must remain small compared to the scale length upon which the electromagnetic field changes significantly.</li>
<li>The particle undergoes many gyrations before the electromagnetic field changes appreciably (slowl-varying fields pproximation). If we let <span class="math inline">\(\rho\)</span> be the particle gyroradius (apart from a factor √2), <span class="math inline">\(x_\mu\)</span> the particle position, <span class="math inline">\(X_\mu\)</span> the GC position, <span class="math inline">\(\tau\)</span> the proper time and <span class="math inline">\(F_{\mu\nu}\)</span> the EM field tensor, the two conditions stated above can be mathematically expressed as <span id="eq-gca-condition1"><span class="math display">\[
\rho \left| \frac{\partial F_{\mu\nu}}{\partial x_\alpha} \right| \ll \left| F_{\mu\nu} \right|
\tag{26.3}\]</span></span> and <span id="eq-gca-condition2"><span class="math display">\[
\frac{1}{\omega} \left| \frac{\partial F_{\mu\nu}}{\partial x_\alpha} \right| \left| \frac{\mathbf{d}X_\beta}{\mathrm{d}\tau} \right| \ll \left| F_{\mu\nu} \right|
\tag{26.4}\]</span></span> where <span class="math inline">\(\omega\)</span> is the gyrofrequency. When the previous conditions hold, we can separate the particle trajectory into a gyration and a motion of the guiding center.</li>
</ol>
</section>
<section id="derivations-of-gc-equation" class="level3" data-number="26.2.3">
<h3 data-number="26.2.3" class="anchored" data-anchor-id="derivations-of-gc-equation"><span class="header-section-number">26.2.3</span> Derivations of GC equation</h3>
<p>The general solution of <a href="#eq-charged-particle-motion-general" class="quarto-xref">Equation&nbsp;<span>26.1</span></a> is a linear combination of the two fundamental solutions related to the four EM tensor eigenvalues <span class="math inline">\(q=\pm i\omega\)</span> and <span class="math inline">\(q=\pm\lambda\)</span>, where <span id="eq-EM-eigenvalues"><span class="math display">\[
\begin{aligned}
\omega &amp;= \frac{e}{mc}\sqrt{\frac{1}{2}(B^2 - E^2) + \frac{1}{2}\sqrt{(B^2 - E^2)^2 + 4(\mathbf{E}\cdot\mathbf{B})^2}} \\
\lambda &amp;= \frac{e}{mc}\sqrt{-\frac{1}{2}(B^2 - E^2) + \frac{1}{2}\sqrt{(B^2 - E^2)^2 + 4(\mathbf{E}\cdot\mathbf{B})^2}}
\end{aligned}
\tag{26.5}\]</span></span></p>
<p><span class="math inline">\(\omega\)</span> is a generalized relativistic form of the Larmor frequency <span class="math inline">\(\omega_\xi = eB/(mc)\)</span> in the case when <span class="math inline">\(E\neq 0\)</span> (which can be verified by solving in the limit <span class="math inline">\(E\to 0\)</span>). The general solution <span class="math inline">\(x_\mu\)</span> of <a href="#eq-charged-particle-motion-general" class="quarto-xref">Equation&nbsp;<span>26.1</span></a> is <span id="eq-charged-particle-motion-general-sol"><span class="math display">\[
x_\mu = \xi_\mu\rho \cos(\omega\tau) - \eta_\mu \rho \sin(\omega\tau) + \alpha_\mu \nu \cosh(\lambda\tau) + \beta_\mu \nu \sinh(\lambda\tau)
\tag{26.6}\]</span></span></p>
<p>Note that the first two terms are related to a periodic motion, that is the gyration around magnetic field lines with gyroradius <span class="math inline">\(\rho\)</span>. Here <span class="math inline">\(\rho, \nu\)</span> are constants defined by the initial conditions and <span class="math inline">\(\xi_\mu,\eta_\mu,\alpha_\mu\)</span> and <span class="math inline">\(\beta_\mu\)</span> are four-versors normalized in the manner <span id="eq-charged-particle-motion-general-sol-normalization"><span class="math display">\[
\xi_\mu^2 = \eta_\mu^2 = 1,\quad \text{and}\quad \alpha_\mu^2 = -\beta_\mu^2 = 1
\tag{26.7}\]</span></span></p>
<p>Solutions for <span class="math inline">\(\rho = 0\)</span> and <span class="math inline">\(\nu = 0\)</span> must be valid separately, so by replacing <span class="math inline">\(x_\mu\)</span> for these two particular cases inside <a href="#eq-charged-particle-motion-general" class="quarto-xref">Equation&nbsp;<span>26.1</span></a> we can see that <span class="math inline">\(\xi_\mu,\eta_\mu,\alpha_\mu\)</span> and <span class="math inline">\(\beta_\mu\)</span> form an orthogonal set of the Minkowsky space. The orthogonality relations between this set of four-vectors in particular states that the periodic motion (gyration) in the <span class="math inline">\((\xi_mu,\eta_\mu)\)</span>-plane is perpendicular to the acceleration motion in the <span class="math inline">\((\alpha_\mu, \beta_\mu)\)</span>-plane, and will be useful later. At this point, another useful relation is retrieved from the squared velocity invariance <span id="eq-sqr-v-invariance"><span class="math display">\[
\frac{\mathrm{d}x_\mu}{\mathrm{d}\tau}\frac{\mathrm{d}x_\mu}{\mathrm{d}\tau} = -c^2,\quad\text{which leads to}\quad \omega^2\rho^2 - \lambda^2\nu^2 = -c^2
\tag{26.8}\]</span></span></p>
<p>Since we are only interested in cases in which gyration appears, the only singular eigenvalue case we must consider is the one with <span class="math inline">\(\lambda=0, \omega\neq 0\)</span>, corresponding to <span class="math inline">\(\mathbf{E}\cdot\mathbf{B}=0\)</span> and <span class="math inline">\(|\mathbf{E}|\to 0\)</span>. The associated solution is <span id="eq-associated-sol"><span class="math display">\[
x_\mu = \xi_\mu\rho \cos(\omega\tau) - \eta_\mu \rho \sin(\omega\tau) + U_\mu \tau
\tag{26.9}\]</span></span></p>
<p>Here the gyration motion with Larmor frequency <span class="math inline">\(\omega_\xi = \omega\)</span> is clearly shown, along with a uniform motion (drift) with velocity <span class="math inline">\(U_\mu = (\gamma c, \mathbf{U})\)</span> in the plane perpendicular to the <span class="math inline">\((\mathbf{E}, \mathbf{B})\)</span>-plane.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In this particular case, the squared velocity invariance <a href="#eq-sqr-v-invariance" class="quarto-xref">Equation&nbsp;<span>26.8</span></a> becomes <span id="eq-sqr-v-invariance1"><span class="math display">\[
\omega^2\rho^2 + U_\mu^2 = -c^2,\quad\text{or}\quad U_\mu^2 = -c^2 - \omega^2\rho^2 &lt; -c^2
\tag{26.10}\]</span></span></p>
<p><a href="#eq-sqr-v-invariance1" class="quarto-xref">Equation&nbsp;<span>26.10</span></a> is of crucial importance in the GCA formalism, because the drift motion <span class="math inline">\(U_\mu\)</span> is the mean motion separated from the gyration and corresponds to the GC motion itself, meaning that what we just found is a relation between the energy and momentum of a particle guiding center. It is very similar to the well-known formula of the squared four-velocity <span class="math inline">\({U_\mu^\prime}^2=-c^2\)</span>, the only difference being an additional term <span class="math inline">\(\omega^2\rho^2\)</span>. This suggests interpreting the motion of the GC as the one of a particle located in the center of gyration, performing no gyration and possessing a squared four velocity as stated in <a href="#eq-sqr-v-invariance1" class="quarto-xref">Equation&nbsp;<span>26.10</span></a>, in agreement with part of the particle kinetic energy being stored in the gyration motion through the term <span class="math inline">\(\omega^2\rho^2\)</span>. By separating the spatial and temporal parts of <span class="math inline">\(U_\mu\)</span> and rearranging some terms inside <a href="#eq-sqr-v-invariance1" class="quarto-xref">Equation&nbsp;<span>26.10</span></a>, we can get a relation for the GC Lorentz factor <span id="eq-gc-gamma"><span class="math display">\[
\gamma_\text{GC} = \sqrt{1+\frac{|\mathbf{U}|^2}{c^2} + \frac{\omega^2\rho^2}{c^2}} = \sqrt{1+\frac{\gamma^2|\mathbf{v}|^2}{c^2} + \frac{\omega^2\rho^2}{c^2}}
\tag{26.11}\]</span></span></p>
<p>Although we only considered a limit case, the same equation can be proven to be generally valid in the GCA formalism.</p>
<p>We now want to isolate the gyration motion in a general case. This is done by separating the motion as follows: <span id="eq-gc-separation-of-motion"><span class="math display">\[
x_\mu = \xi_\mu x + \eta_\mu y + x_\mu^\prime + X_\mu
\tag{26.12}\]</span></span> where <span class="math inline">\(x_\mu\)</span> is the space-time position of the particle and <span class="math inline">\(X_\mu\)</span> is the position of the guiding center. We associate two variables <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> to describe the periodic motion in the <span class="math inline">\((\xi, \eta)\)</span>-plane, and the term <span class="math inline">\(x_\mu^\prime\)</span> will account for the periodic motions which do not lie in the same plane. To more easily describe the gyration, we also choose a new pair of variables <span id="eq-gc-new-vars"><span class="math display">\[
\zeta = \frac{1}{\sqrt{2}}\left( x+ iy \right)\quad\text{and}\quad \zeta^\ast = \frac{1}{\sqrt{2}}\left( x - iy \right)
\tag{26.13}\]</span></span> so that <span class="math inline">\(\xi_\mu x + \eta_\mu y = \delta_\mu\zeta + \sigma_\mu\zeta^\ast\)</span>. The new variables will allow us to choose <span class="math inline">\(\zeta_\mu\)</span> and <span class="math inline">\(\delta_\mu\)</span> in a more convenient way and let some factor <span class="math inline">\(e^{i\phi}\)</span> account for the initial conditions of the problem. We rewrite the particle coordinate using <a href="#eq-gc-new-vars" class="quarto-xref">Equation&nbsp;<span>26.13</span></a> <span id="eq-eq-gc-new-vars2"><span class="math display">\[
x_\mu = \delta_\mu\zeta + \sigma_\mu\zeta^\ast + x_\mu^\prime + X_\mu
\tag{26.14}\]</span></span></p>
<p>The next step is substituting this expression into <a href="#eq-charged-particle-motion-general" class="quarto-xref">Equation&nbsp;<span>26.1</span></a> and expand the second derivative, which leads to a lengthy expression containing eight unkowns: <span class="math inline">\(\zeta,\zeta^\ast\)</span>, two components of <span class="math inline">\(x_\mu\)</span> (the condition with the <span class="math inline">\((\sigma, \delta)\)</span>-plane sets the other two), and four components of <span class="math inline">\(X_\mu\)</span>.</p>
<p>The conditions for the GCA expressed in <a href="#eq-gca-condition2" class="quarto-xref">Equation&nbsp;<span>26.4</span></a> implicitly contain a parameter of smallness <span class="math inline">\(\epsilon =|u/\omega L|\ll 1\)</span>, where u is the typical particle four-velocity and L the scale length upon which the change in the EM fields <span class="math inline">\(F_{\mu\nu}\)</span> is comparable to <span class="math inline">\(F_{\mu\nu}\)</span> (slowly-varying fields approximation). This allows us to approximate <span class="math inline">\(F_{\mu\nu}(x_\mu)\)</span> (particle coordinate) by using a Taylor expansion about <span class="math inline">\(X_\mu\)</span> (the GC coordinate) <span class="math display">\[
\begin{aligned}
F_{\mu\nu}(x_\mu) =&amp; F_{\mu\nu}(X_\mu) \\
&amp;+ \frac{\partial F_{\mu\nu}}{\partial x_\xi}(\delta_\xi \zeta + \sigma_\xi \zeta^\ast) \\
&amp;+ \frac{1}{2} \frac{\partial^2 F_{\mu\nu}}{\partial x_\xi\partial x_\pi}\left[ \delta_\xi\delta_\pi \zeta^2 + \sigma_\xi\sigma_\pi {\zeta^\ast}^2 + (\sigma_\xi \delta_\pi + \sigma_\pi \delta_\xi)|\zeta|^2 \right] \\
&amp;+ \frac{\partial F_{\mu\nu}}{\partial x_\xi} x_\xi^\prime + ...
\end{aligned}
\]</span></p>
<p>We should now substitute <span class="math inline">\(F_{\mu\nu}(x_\mu)\)</span> inside <a href="#eq-charged-particle-motion-general" class="quarto-xref">Equation&nbsp;<span>26.1</span></a> using the new coordinates in order to get a quite long equation containing all quantities evaluated at the GC position <span class="math inline">\(X_\mu\)</span> up to 2nd−order, and group all 2nd−order terms on the right-end side as <span class="math inline">\(G_\mu\)</span> <span id="eq-gc-expansion"><span class="math display">\[
\begin{aligned}
&amp;\delta_\mu\frac{\mathrm{d}^2\zeta}{\mathrm{d}\tau^2} + \sigma_\mu\frac{\mathrm{d}^2\zeta^\ast}{\mathrm{d}\tau^2}+\left( i\omega\delta_\mu + 2\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} \right)\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} \\
&amp;+\left( -i\omega\sigma_\mu + 2\frac{\mathrm{d}\sigma_\mu}{\mathrm{d}\tau} \right) \frac{\mathrm{d}\zeta^\ast}{\mathrm{d}\tau} + \frac{\mathrm{d}^2\delta_\mu}{\mathrm{d}\tau^2}\zeta + \frac{\mathrm{d}^2\sigma_\mu}{\mathrm{d}\tau^2}\zeta^\ast \\
&amp;- \frac{\partial F_{\mu\nu}}{\partial x_\xi}\left( \delta_\xi \zeta + \sigma_\xi \zeta^\ast \right)\frac{\mathrm{d}X_\nu}{\mathrm{d}\tau} - F_{\mu\nu}\left( \frac{\mathrm{d}\delta_\nu}{\mathrm{d}\tau}\zeta + \frac{\mathrm{d}\sigma_\nu}{\mathrm{d}\tau}\zeta^\ast \right) \\
&amp;- \frac{\partial F_{\mu\nu}}{\partial x_\xi}\left( \delta_\xi \zeta + \sigma_\xi \zeta^\ast \right) \left( \delta_\nu\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} + \sigma_\nu\frac{\mathrm{d}\zeta^\ast}{\mathrm{d}\tau} \right) \\
&amp;+ \left( \frac{\mathrm{d}^2 X_\nu}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}X_\mu}{\mathrm{d}\tau} \right) + \left( \frac{d^2 x_\mu^\prime}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}x_\nu^\prime}{\mathrm{d}\tau} \right) = G_\mu
\end{aligned}
\tag{26.15}\]</span></span></p>
<p>An expression for <span class="math inline">\(\zeta\)</span> is needed to further proceed, but since the derivation is quite long we will not explicitly derive it here. The basic idea is to use the orthogonality equations for the new four-vectors <span class="math inline">\(\sigma_\mu\)</span> and <span class="math inline">\(\delta_\mu\)</span> and the antisymmetry property of the EM tensor inside Maxwell’s equations written in tensorial form, and then assume that a solution for <span class="math inline">\(X_\mu\)</span> has already been found. Considered that <span class="math inline">\(x_\mu\)</span> is a 1st−order term in the GCA, by ignoring 2nd−order quantities and writing terms independent from <span class="math inline">\(\zeta\)</span> as a numerical value <span class="math inline">\(P\)</span>, then <a href="#eq-gc-expansion" class="quarto-xref">Equation&nbsp;<span>26.15</span></a> becomes <span id="eq-gc-expansion2"><span class="math display">\[
\frac{\mathrm{d}^2\zeta}{\mathrm{d}\tau^2} + i\Omega\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} + \frac{i}{2}\frac{\mathrm{d}\Omega}{\mathrm{d}\tau}\zeta + \Omega a \zeta + P = 0
\tag{26.16}\]</span></span> where <span class="math inline">\(\Omega a \zeta\)</span> contains all the linear terms in <span class="math inline">\(\zeta\)</span>. Consequently, the corresponding solution <span class="math inline">\(\zeta\)</span>, by analogy to the <em>Wentzel–Kramers–Brillouin (WKB)</em> approximation in quantum mechanics, is <span id="eq-gc-wkb"><span class="math display">\[
\zeta = \rho_0 \sqrt{\frac{\omega_0}{\Omega}}\exp\left[ -i\left( \Phi + \int_{\tau_0}^\tau \sigma_1 \mathrm{d}\tau \right) \right]
\tag{26.17}\]</span></span> to the 0th-order, being <span id="eq-gc-wkb2"><span class="math display">\[
\Omega = \omega - 2i\sigma_\mu \frac{\mathrm{d}\delta_\mu}{\mathrm{d}\tau},\quad \Phi = \int_{\tau_0}^{\tau}\Omega\mathrm{d}\tau - \phi,\quad\text{and}\quad \sigma = a - \frac{a^2}{\Omega}
\tag{26.18}\]</span></span> The subscripts 0, 1 indicate the associated order of approximation for quantities defined above.</p>
<p>Since now we know the expression for <span class="math inline">\(\zeta\)</span>, we can write the 1st−order EOM for <span class="math inline">\(X_\mu\)</span>. For this purpose, we require that in the left-end side of <a href="#eq-gc-expansion" class="quarto-xref">Equation&nbsp;<span>26.15</span></a> the terms containing the 1st− and 2nd−order derivatives of <span class="math inline">\(X_\mu\)</span> are balanced by the remaining nonoscillatory terms, that is <span id="eq-gc-balance"><span class="math display">\[
\frac{\mathrm{d}^2 X_\mu}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}X_\nu}{\mathrm{d}\tau} = \frac{\partial F_{\mu\nu}}{\partial x_\xi}\left( \delta_\xi \sigma_\nu \frac{\mathrm{d}\zeta^\ast}{\mathrm{d}\tau} + \delta_\nu \sigma_\xi \frac{\mathrm{d}\zeta}{\mathrm{d}\tau} \right)
\tag{26.19}\]</span></span></p>
<p>Having found the solution <a href="#eq-gc-wkb" class="quarto-xref">Equation&nbsp;<span>26.17</span></a> and making use once again of the orthogonality relations for <span class="math inline">\(\delta_\mu\)</span> and <span class="math inline">\(\sigma_\mu\)</span> and the tensorial Maxwell’s equations, we can write the equation of motion for the GC <span id="eq-gc-eom"><span class="math display">\[
\frac{\mathrm{d}^2 X_\mu}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}X_\nu}{\mathrm{d}\tau} + \rho_0^2 \omega_0\frac{\partial\omega}{\partial x_\mu} = 0
\tag{26.20}\]</span></span> where <span class="math inline">\(\omega\)</span> (<a href="#eq-EM-eigenvalues" class="quarto-xref">Equation&nbsp;<span>26.5</span></a>) is the generalized Larmor frequency, <span class="math inline">\(\rho_0^2 \omega_0 = \mu_0 = mc\gamma^2 v_\perp^2 / 2eB\)</span> is the 0th-order approximation (apart from a constant factor) to the particle magnetic moment <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\omega_0 = eB/(mc)\)</span> represents the lowest-order approximation to the Larmor frequency in the case <span class="math inline">\(E\ll B\)</span>.</p>
<p>More precisely, the magnetic moment should be regarded as constant only in the reference frame moving at <span class="math inline">\(\mathbf{v}_E\)</span>, because in that particular case <span class="math inline">\(\mathbf{E} = 0\)</span>. Indeed, a formal analysis (<span class="citation" data-cites="northrop1960stability">Northrop and Teller (<a href="#ref-northrop1960stability" role="doc-biblioref">1960</a>)</span>) shows that the corresponding constant of motion in a general reference frame is actually an asymptotic series expansion in a smallness parameter <span class="math inline">\(\epsilon=u/(\omega_0 L)\)</span> in the form <span class="math inline">\(\mu = (e/c)\left[ \mu_0 + \epsilon \mu_1 + \epsilon^2 \mu_2 + ... \right]\)</span> so that <span class="math inline">\(\mu_0\)</span> is not constant and can still vary in compliance with the adiabatic theory. Nevertheless, extensive numerical testing confirms that the errors due to assuming <span class="math inline">\(\mathrm{d}\mu_0 / \mathrm{d}t \approx 0\)</span> are at most of the same order of those introduced by the GC formalism, as a consequence of the slowly varying field condition which prevents sensible changes in the magnetic moment. Hence, we safely assume that <span class="math inline">\(\mu \approx (e/c)\mu_0\)</span> is invariant.</p>
</section>
<section id="first-order-solution-for-the-gca-equations-of-motion" class="level3" data-number="26.2.4">
<h3 data-number="26.2.4" class="anchored" data-anchor-id="first-order-solution-for-the-gca-equations-of-motion"><span class="header-section-number">26.2.4</span> First order solution for the GCA equations of motion</h3>
<p>Although deceitful simple, the GC equation of motion <a href="#eq-gc-eom" class="quarto-xref">Equation&nbsp;<span>26.20</span></a> is more conveniently cast in a form in which the GC velocity appears explicitly, under the nearly-crossed (EM) fields condition <span id="eq-nearly-cross-em"><span class="math display">\[
\frac{\mathbf{E}_\parallel \cdot\mathbf{B}}{B^2 - E_\perp^2} \ll 1
\tag{26.21}\]</span></span> where the subscripts <span class="math inline">\(\parallel\)</span> and <span class="math inline">\(\perp\)</span> indicate the parallel and perpendicular components of the electric field with respect to the magnetic field unit vector <span class="math inline">\(\hat{b}\)</span>. It can be proven that <a href="#eq-nearly-cross-em" class="quarto-xref">Equation&nbsp;<span>26.21</span></a> allows the EM tensor field <span class="math inline">\(F_{\mu\nu}\)</span> to be split into a contribution <span class="math inline">\(F_{\mu\ni}^{(0)}\)</span> constructed solely from <span class="math inline">\(\mathbf{E}_\perp\)</span> and <span class="math inline">\(\mathbf{B}\)</span>, plus a correction term <span class="math inline">\(F_{\mu\nu}^{(1)}\)</span> depending on <span class="math inline">\(\mathbf{E}_\parallel\)</span>. A formal analysis leads to the conclusion that the GC four-velocity <span class="math inline">\(U_\mu \equiv \mathrm{d}X_\mu/\mathrm{d}\tau\)</span> can be decomposed into a 0th-order contribution <span class="math inline">\(\mathrm{U}^{(0)}\)</span> (which contains the drift velocity <span class="math inline">\(\mathbf{v}_E = c\mathbf{E}_\perp \times\mathbf{B}/B^2\)</span> as well as the velocity component parallel to the magnetic field line <span class="math inline">\(v_\parallel \hat{b}\)</span>) plus 1st-order correction <span class="math inline">\(\mathbf{U}^{(1)}\)</span>, leading to <span id="eq-four-velocity-decomposition"><span class="math display">\[
U_\mu = (\gamma c, \mathbf{U}) \simeq (\gamma c, \gamma v_\parallel \hat{b} + \gamma \mathbf{v}_E + \mathbf{U}^{(1)})
\tag{26.22}\]</span></span> where <span class="math inline">\(\gamma\)</span> is the particle Lorentz factor <span class="math inline">\(\gamma = (1- v^2/c^2)^{-1/2}\)</span>. An equation for <span class="math inline">\(\mathbf{U}^{(1)}\)</span> can be derived from <a href="#eq-gc-eom" class="quarto-xref">Equation&nbsp;<span>26.20</span></a> using a recursive approach as shown below, while from the spatial component one obtains an equation (to the same order) for the parallel component of the GC four-velocity <span class="math inline">\(\gamma v_\parallel\)</span>. These yield the (1st-order) GCA system of ordinary differential equations (ODEs) <span id="eq-gc-eom-1st-sol"><span class="math display">\[
\begin{aligned}
\frac{\mathrm{d}\mathbf{X}}{\mathrm{d}t} &amp;= \mathbf{v}_E + v_\parallel \hat{b} + \frac{\gamma_E^2}{B}\hat{b}\times\left[ \frac{mc\gamma}{e}\left( v_\parallel\mathcal{L}(\hat{b}) + \mathcal{L}(\mathbf{v}_E) \right) + \mathcal{M}\left( \frac{B}{\gamma_E} \right) + \frac{v_\parallel E_\parallel}{c}\mathbf{v}_E \right] \\
\frac{\mathrm{d}(\gamma v_\parallel)}{\mathrm{d}t} &amp;= \frac{e}{m}E_\parallel - \gamma\hat{b}\cdot\mathcal{L}(\mathbf{v}_E) - \frac{\mu}{\gamma m}\hat{b}\cdot\nabla\left(\frac{B}{\gamma_E}\right)
\end{aligned}
\tag{26.23}\]</span></span> where <span class="math inline">\(\mathrm{d}\mathbf{X}/\mathrm{d}t = \mathbf{U}^{(1)}/\gamma\)</span> represents the velocity of the guiding center, <span class="math inline">\(e/m\)</span> is the particle charge-to-mass ratio and <span class="math inline">\(\mu_0 = c\mu/e\)</span>. The operators <span class="math inline">\(\mathcal{L}\)</span> and <span class="math inline">\(\mathcal{M}\)</span> are defined as <span id="eq-gc-eom-1st-operator"><span class="math display">\[
\begin{aligned}
\mathcal{L}(x) &amp;= \frac{\partial\mathbf{x}}{\partial t} + v_\parallel(\hat{b}\cdot\nabla)\mathbf{x} + (\mathbf{v}_E\cdot\nabla)\mathbf{x} \\
\mathcal{M}(x) &amp;= \frac{\mu}{e\gamma}\left[ \frac{\mathbf{v}_E}{c}\frac{\partial x}{\partial t} + c\nabla x \right]
\end{aligned}
\tag{26.24}\]</span></span> where <span class="math inline">\(\gamma_E = (1 - E_\perp^2/B^2)^{-1/2}\)</span> is the Lorentz factor associated to the drift velocity <span class="math inline">\(\mathbf{v}_E\)</span>.</p>
<p>In the GCA <a href="#eq-gc-eom-1st-sol" class="quarto-xref">Equation&nbsp;<span>26.23</span></a> information about motion perpendicular to the magnetic field is lost and the only component of the particle velocity that is actually evolved in time is <span class="math inline">\(u_\parallel\)</span>, because the magnetic moment <span class="math inline">\(\mu_0\approx c\mu/e\)</span> is now considered a constant of motion. Each term on the right hand side of <a href="#eq-gc-eom-1st-sol" class="quarto-xref">Equation&nbsp;<span>26.23</span></a> corresponds to a specific drift motion. Indeed, the first term represents the <span class="math inline">\(\mathbf{E}\times\mathbf{B}\)</span> perpendicular drift, while the second one accounts for particle motion in the direction parallel to magnetic field. The first two terms in square bracket, <span class="math inline">\(\mathcal{L}(\hat{b})\)</span> and <span class="math inline">\(\mathcal{L}(\mathbf{v}_E)\)</span>, describe the field curvature and polarization drifts<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, respectively. The next term is the <span class="math inline">\(\nabla-B\)</span> drift, while the last one represents a relativistic drift in the direction given by <span class="math inline">\(\hat{b}\times\mathbf{v}_E\)</span>.</p>
<p><a href="#eq-gc-eom-1st-sol" class="quarto-xref">Equation&nbsp;<span>26.23</span></a> lose their validity when either <span class="math inline">\(B\to 0\)</span> (magnetic null) or <span class="math inline">\(E_\perp \ge B\)</span>, i.e.&nbsp;when the nearly-crossed EM fields condition, <a href="#eq-nearly-cross-em" class="quarto-xref">Equation&nbsp;<span>26.21</span></a>, is violated. While the first condition can easily occur inside a current sheet, the second may occur in a non-ideal MHD regime only. Violation of either condition breaks down the GCA and can lead to severe numerical errors.</p>
</section>
<section id="recursive-solution" class="level3" data-number="26.2.5">
<h3 data-number="26.2.5" class="anchored" data-anchor-id="recursive-solution"><span class="header-section-number">26.2.5</span> Recursive solution</h3>
<p>An explicit solution for <a href="#eq-gc-eom" class="quarto-xref">Equation&nbsp;<span>26.20</span></a> can be found under <a href="#eq-nearly-cross-em" class="quarto-xref">Equation&nbsp;<span>26.21</span></a>, which introduces a new parameter of smallness <span class="math inline">\(\lambda / \omega \ll 1\)</span>.</p>
</section>
<section id="energy-conservation" class="level3" data-number="26.2.6">
<h3 data-number="26.2.6" class="anchored" data-anchor-id="energy-conservation"><span class="header-section-number">26.2.6</span> Energy conservation</h3>
<p>The time component of <a href="#eq-gc-eom" class="quarto-xref">Equation&nbsp;<span>26.20</span></a> leads to an evolutionary ODE for the particle energy as a function of time, namely <span id="eq-gc-eom-time"><span class="math display">\[
\frac{\mathrm{d}\gamma c^2}{\mathrm{d}t} = \frac{e}{m}\frac{\mathrm{d}\mathbf{X}}{\mathrm{d}t}\cdot\mathbf{E} + \frac{\mu}{m}\frac{\partial}{\partial t}\left( \frac{B}{\gamma_E} \right)
\tag{26.25}\]</span></span></p>
<p>In the time-independent case, <a href="#eq-gc-eom-time" class="quarto-xref">Equation&nbsp;<span>26.25</span></a> clearly shows that, when the GC velocity is perpendicular to the electric field, no acceleration occurs and the particle energy is conserved. For numerical purposes, however, <a href="#eq-gc-eom-time" class="quarto-xref">Equation&nbsp;<span>26.25</span></a> is not solved for retrieving the Lorentz <span class="math inline">\(\gamma\)</span>-factor, since large values of the right hand side could easily violate the condition <span class="math inline">\(\gamma\ge 1\)</span> at the truncation level of the scheme, unless small time steps are taken. In practice, to an 1st-order approximation, the particle velocity can be decomposed into a parallel component <span class="math inline">\(v_\parallel\)</span>, a drift component <span class="math inline">\(v_E\)</span> and a gyration component <span class="math inline">\(v_\perp\)</span>. This leads to the normalization condition <span id="eq-gc-eom-normalization-1st"><span class="math display">\[
\gamma^2( c^2 - v_\parallel^2 - v_\perp^2 - v_E^2) = c^2
\tag{26.26}\]</span></span></p>
<p>From the definition of the magnetic moment and the Larmor frequency <span class="math inline">\(\mu_0 = mc\gamma^2 v_\perp^2/(2eB) = \gamma^2 v_\perp^2/(2\omega_0)\)</span>, we compute the particle Lorentz factor as <span id="eq-gc-eom-lorentz"><span class="math display">\[
\gamma = \sqrt{\frac{c^2 + \gamma^2 v_\parallel^2 + 2\mu_0 \omega_0}{c^2 - v_E^2}}
\tag{26.27}\]</span></span></p>
<p><a href="#eq-gc-eom-lorentz" class="quarto-xref">Equation&nbsp;<span>26.27</span></a> replaces <a href="#eq-gc-eom-time" class="quarto-xref">Equation&nbsp;<span>26.25</span></a> in common numerical solvers to get the Lorentz factor.</p>
</section>
</section>
<section id="validity-and-higher-order-corrections" class="level2" data-number="26.3">
<h2 data-number="26.3" class="anchored" data-anchor-id="validity-and-higher-order-corrections"><span class="header-section-number">26.3</span> Validity and Higher-Order Corrections</h2>
<p>The standard guiding center approximation is a first-order expansion in the Larmor radius <span class="math inline">\(\rho_L\)</span>. Its validity depends on the variation of the magnetic field being small across the gyroradius. A rigorous criterion requires analyzing the tensor of field derivatives: <span class="math display">\[
\frac{\sqrt{\lambda_{max}} \rho_\perp}{B} \ll 1
\]</span> where <span class="math inline">\(\lambda_{max}\)</span> is the maximum eigenvalue of the tensor involving gradients, curvature, and shearing of the field lines.</p>
<p>When field variations are strong (e.g., near sharp field reversals or current sheets), first-order approximations fail. Higher-order corrections (such as the Baños drift) may be required, which add terms proportional to the parallel curl of the magnetic field: <span class="math display">\[
\langle \dot{z} \rangle - \langle v_\parallel \rangle \approx \frac{\mu B}{m \omega_0} \hat{b} \cdot (\nabla \times \hat{b})
\]</span> This correction accounts for the discrepancy between the average particle velocity and the guiding center velocity due to field line shearing.</p>
<section id="numerical-implementation" class="level3" data-number="26.3.1">
<h3 data-number="26.3.1" class="anchored" data-anchor-id="numerical-implementation"><span class="header-section-number">26.3.1</span> Numerical implementation</h3>
<p>The GCA <a href="#eq-gc-eom-1st-sol" class="quarto-xref">Equation&nbsp;<span>26.23</span></a> contains a set of 4 ODEs with unknowns <span class="math inline">\((\mathbf{X}, u_\parallel)\)</span>. The terms which require evaluation at grids are</p>
<ul>
<li><span class="math inline">\(\mathbf{B}\)</span></li>
<li><span class="math inline">\(c\mathbf{E}\)</span></li>
<li><span class="math inline">\((\hat{b}\cdot\nabla)\hat{b}\)</span></li>
<li><span class="math inline">\((\hat{b}\cdot\nabla)\mathbf{v}_E\)</span></li>
<li><span class="math inline">\((\mathbf{v}_E\cdot\nabla)\mathbf{v}_E\)</span></li>
<li><span class="math inline">\((\mathbf{v}_E\cdot\nabla)\hat{b}\)</span></li>
<li><span class="math inline">\(\nabla(B/\gamma_E)\)</span></li>
</ul>
<p><span class="citation" data-cites="mignone2023guiding">Mignone, Haudemand, and Puzzoni (<a href="#ref-mignone2023guiding" role="doc-biblioref">2023</a>)</span> reports the implementation of GCA in the PLUTO MHD model.</p>
</section>
<section id="nonrelativistic-case" class="level3" data-number="26.3.2">
<h3 data-number="26.3.2" class="anchored" data-anchor-id="nonrelativistic-case"><span class="header-section-number">26.3.2</span> Nonrelativistic case</h3>
<p>In the nonrelativistic case, <span class="math inline">\(\gamma = 1\)</span> so we don’t need to solve <a href="#eq-gc-eom-lorentz" class="quarto-xref">Equation&nbsp;<span>26.27</span></a>. <a href="#eq-gc-eom-1st-sol" class="quarto-xref">Equation&nbsp;<span>26.23</span></a> can be simplified into <span id="eq-gc-eom-1st-sol-nonrelativistic"><span class="math display">\[
\begin{aligned}
\frac{\mathrm{d}\mathbf{X}}{\mathrm{d}t} &amp;=  \\
\frac{\mathrm{d}(v_\parallel)}{\mathrm{d}t} &amp;=
\end{aligned}
\tag{26.28}\]</span></span></p>
</section>
</section>
<section id="hamiltonian-theory-of-guiding-center-motion" class="level2" data-number="26.4">
<h2 data-number="26.4" class="anchored" data-anchor-id="hamiltonian-theory-of-guiding-center-motion"><span class="header-section-number">26.4</span> Hamiltonian Theory of Guiding Center Motion</h2>
<p>Following the review by <span class="citation" data-cites="cary2009hamiltonian">Cary and Brizard (<a href="#ref-cary2009hamiltonian" role="doc-biblioref">2009</a>)</span>.</p>
<p>Canonical and noncanonical Hamiltonian formulations of guiding-center motion offer improvements over non-Hamiltonian formulations: Hamiltonian formulations possess Noether’s theorem (hence invariants follow from symmetries), and they preserve the Poincaré invariants (so that spurious attractors are prevented from appearing in simulations of guiding-center dynamics). Hamiltonian guiding-center theory is guaranteed to have an energy conservation law for time-independent fields—something that is not true of non-Hamiltonian guiding-center theories. The use of the phase-space Lagrangian approach facilitates this development, as there is no need to transform a priori to canonical coordinates, such as flux coordinates, which have less physical meaning.</p>
<section id="noncanonical-hamiltonian-guiding-center-theory" class="level3" data-number="26.4.1">
<h3 data-number="26.4.1" class="anchored" data-anchor-id="noncanonical-hamiltonian-guiding-center-theory"><span class="header-section-number">26.4.1</span> Noncanonical Hamiltonian guiding center theory</h3>
<p>The guiding-center phase space consists of</p>
<ul>
<li><p>the guiding-center position <span class="math inline">\(\mathbf{X}\)</span>, essentially the center of the helix;</p></li>
<li><p>the guiding-center parallel velocity variable <span class="math inline">\(u\equiv \hat{b}\cdot\dot{\mathbf{X}}\)</span>;</p></li>
<li><p>the (lowest-order) magnetic moment, <span id="eq-magnetic-moment-lowest-order-gc"><span class="math display">\[
\mu \equiv \frac{m |\mathbf{w}|^2}{2B(\mathbf{X}, t)}
\tag{26.29}\]</span></span> where <span class="math inline">\(\mathbf{w} = \mathbf{v}_\perp - \mathbf{v}_E\)</span> is the perpendicular velocity in the local frame moving with the <span class="math inline">\(\mathbf{E}\times\mathbf{B}\)</span> drift velocity <span class="math inline">\(\mathbf{v}_E\equiv c\mathbf{E}\times\hat{b}/B\)</span>.</p></li>
<li><p>and the ignorable gyrophase <span class="math inline">\(\zeta\)</span>, which gives the location of the particle on the circle about the guiding center.</p></li>
</ul>
<p>As there are still six variables parametrizing phase space, there is no loss of information in making the guiding-center transformation <span class="math inline">\((\mathbf{x},\mathbf{v}) \to (\mathbf{X},u,\mu,\zeta)\)</span>. For the sake of simplicity of notation, we occasionally use the gyroaction variable <span class="math inline">\(J \equiv mc/e\mu\)</span> instead of the magnetic moment <span class="math inline">\(\mu\)</span> whenever we need to refer to the action-angle coordinates <span class="math inline">\(J,\zeta\)</span> associated with gyromotion.</p>
<p>The equations of motion for these variables are given by the guiding-center phase-space Lagrangian, <span id="eq-gc-lagrangian"><span class="math display">\[
\mathcal{L}_\text{gc}(\mathbf{X},u,\mu,\zeta;t) = \left[ \frac{e}{c}\mathbf{A}(\mathbf{X},t) + mu\hat{b}(\mathbf{X},t) \right]\cdot\dot{\mathbf{X}} + J\dot{\zeta} - H_\text{gc}
\tag{26.30}\]</span></span> in which the guiding-center Hamiltonian is given by <span id="eq-gc-hamiltonian"><span class="math display">\[
H_\text{gc}(\mathbf{X},u,\mu;t) = \frac{m}{2}u^2 + \mu B(\mathbf{X},t) + e\phi(\mathbf{X},t) - \frac{m}{2}\left| \mathbf{v}_E \right|^2
\tag{26.31}\]</span></span></p>
<p>The arguments are shown here to emphasize that, for example, the magnetic-field strength <span class="math inline">\(B(\mathbf{X},t)\)</span> is evaluated at the guiding-center position <span class="math inline">\(\mathbf{X}\)</span>, not at the particle position <span class="math inline">\(\mathbf{x}\)</span>. Here and throughout, the effects of a gravitational field may by found by adding the gravitational <span class="math inline">\(m\Phi_G\)</span> to the electrostatic potential energy <span class="math inline">\(e\Phi\)</span>. In addition, we now drop the adjective phase space, as the guiding-center Lagrangian is always henceforth a phase-space Lagrangian.</p>
<p>The guiding-center Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a> comes not simply from gyrophase averaging, but from a transformation from the physical (particle) variables <span class="math inline">\((\mathbf{x},\mathbf{v})\)</span> to the guiding-center variables <span class="math inline">\((\mathbf{X},u,\mu,\zeta)\)</span>. The relation between the physical location <span class="math inline">\(\mathbf{x}\)</span> and the guiding-center position <span class="math inline">\(\mathbf{X}\)</span> is <span id="eq-gc-relation"><span class="math display">\[
\mathbf{x} \equiv \mathbf{X} + \pmb{\rho}
\tag{26.32}\]</span></span> where <span class="math inline">\(\pmb{\rho}\)</span> denotes the gyroradius displacement vector in the frame drifting with <span class="math inline">\(\mathbf{v}_E\)</span>. Here we simply note that the displacement vector <span class="math inline">\(\pmb{\rho}\equiv \tilde{\pmb{\rho}} + \bar{\pmb{\rho}}\)</span> has a part (denoted by tilde) that is explicitly gyrophase dependent and a part (denoted by bar) that is gyrophase independent. In what follows, we show that the latter part <span id="eq-gc-gyroradius-bar"><span class="math display">\[
\bar{\pmb{\rho}} = \frac{\hat{b}}{\Omega}\times\mathbf{v}_E = \frac{c\mathbf{E}_\perp}{\Omega B}
\tag{26.33}\]</span></span> denotes the guiding-center polarization displacement (Kaufman, Phys. Fluids, 1986). …</p>
<p>Our guiding-center Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a> is obtained from an ordering in which the scalar potential <span class="math inline">\(\Phi\)</span> is one order lower than the particle kinetic energy, unlike previous derivations of the Hamiltonian theory of guiding-center motion. In this ordering, the electric drift <span class="math inline">\(\mathbf{v}_E\)</span> is of the same order as the perpendicular velocity <span class="math inline">\(\mathbf{w}\)</span>, as in some non-Hamiltonian calculations (<span class="citation" data-cites="northrop1963adiabatic">Northrop (<a href="#ref-northrop1963adiabatic" role="doc-biblioref">1963</a>)</span>). As we will see, this ordering allows us to obtain the polarization drift in the same order as the curvature and <span class="math inline">\(\nabla B\)</span> drifts, although it appears differently in the theory. However, for consistency the parallel electric field <span class="math inline">\(E_\parallel = \mathbf{E}\cdot\hat{b}\)</span> must be smaller by one order than the perpendicular field <span class="math inline">\(\mathbf{E}_\perp\)</span> (<a href="#eq-nearly-cross-em" class="quarto-xref">Equation&nbsp;<span>26.21</span></a>).</p>
<p>The variables <span class="math inline">\((J,\zeta)\)</span> appear in canonical form in the symplectic part of the guiding-center Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a> as <span class="math inline">\(J\dot{\zeta}\)</span> while the guiding-center Hamiltonian <span class="math inline">\(H_\text{gc}\)</span> depends on <span class="math inline">\(J\)</span> (or <span class="math inline">\(\mu\)</span>) alone. The Hamilton equations for <span class="math inline">\((J,\zeta)\)</span> are <span id="eq-gc-hamilton-J-zeta"><span class="math display">\[
\begin{aligned}
\dot{J} &amp;= -\frac{\partial H_\text{gc}}{\partial \zeta} \equiv 0 \\
\dot{\zeta} &amp;= \frac{\partial H_\text{gc}}{\partial J} \equiv \Omega
\end{aligned}
\tag{26.34}\]</span></span></p>
<p><a href="#eq-gc-hamilton-J-zeta" class="quarto-xref">Equation&nbsp;<span>26.34</span></a> shows that the gyroaction (or magnetic moment) is conserved by the guiding-center equations of motion. This also follows from Noether’s theorem since the gyrophase <span class="math inline">\(\zeta\)</span> is an ignorable coordinate, i.e., only its time derivative appears in the guiding-center Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a>.</p>
<p>If one is concerned with only the motion of the guiding center and not the evolution of the gyrophase, the term linear in <span class="math inline">\(\dot{\zeta}\)</span> can be dropped from the guiding-center Lagrangian, as it does not affect the equations of motion of the other variables, <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(u\)</span>. In the evolution equations for <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(u\)</span>, the adiabatic invariant <span class="math inline">\(\mu\)</span> (or <span class="math inline">\(J\)</span>) does appear but only as a guiding-center dynamical parameter.</p>
<p>Variation of the guiding-center Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a> with respect to the variable <span class="math inline">\(u\)</span> gives the Euler-Lagrange equation <span class="math display">\[
0 = \frac{\partial\mathcal{L}}{\partial u} = m\hat{b}\cdot\dot{\mathbf{X}} - \frac{\partial H_\text{gc}}{\partial u}
\]</span> which yields <span id="eq-gc-euler-lagrange1"><span class="math display">\[
u \equiv \hat{b}\cdot\dot{\mathbf{X}}
\tag{26.35}\]</span></span></p>
<p>Thus, the guiding-center Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a> dictates that <span class="math inline">\(u\)</span> is the velocity of the guiding center in the direction of the magnetic field at the guiding center.</p>
<p>Last, we vary the Lagrangian <a href="#eq-gc-lagrangian" class="quarto-xref">Equation&nbsp;<span>26.30</span></a> with respect to the guiding-center position <span class="math inline">\(\mathbf{X}\)</span>, and obtain the Euler-Lagrange equation <span id="eq-gc-euler-lagrange2"><span class="math display">\[
\begin{aligned}
m\dot{u}\hat{b} =&amp; e\mathbf{E} - \mu\nabla B + \frac{m}{2}\nabla |\mathbf{v}_E|^2 - mu\frac{\partial\hat{b}}{\partial t} \\
&amp; + \dot{\mathbf{X}}\times\left( \frac{e}{c}\mathbf{B}+mu\nabla\times\hat{b} \right) \\
\equiv&amp; e\left( \mathbf{E}^\ast + \frac{1}{c}\dot{\mathbf{X}}\times\mathbf{B}^\ast \right)
\end{aligned}
\tag{26.36}\]</span></span> where the <em>effective</em> EM fields <span id="eq-gc-effective-em"><span class="math display">\[
\mathbf{E}^\ast \equiv -\nabla\Phi^\ast - \frac{1}{c}\frac{\partial\mathbf{A}^\ast}{\partial t}\quad\text{and}\quad \mathbf{B}^\ast \equiv\nabla\times\mathbf{A}^\ast
\tag{26.37}\]</span></span> are defined in terms of the effective EM potentials <span id="eq-gc-effective-em-potentials"><span class="math display">\[
\begin{aligned}
e\Phi^\ast &amp;\equiv e\Phi + \mu B -\frac{m}{2}|\mathbf{v}_E|^2 \\
\mathbf{A}^\ast &amp;\equiv \mathbf{A} + \frac{mc}{e}u\hat{b}
\end{aligned}
\tag{26.38}\]</span></span></p>
<p>The guiding-center canonical momentum is now simply expressed as <span class="math inline">\(e\mathbf{A}^\ast /c\)</span> and the guiding-center Hamiltonian is <span class="math inline">\(e\Phi^\ast + mu^2/2\)</span>.</p>
<p>We obtain the rate of change of the variable <span class="math inline">\(u\)</span> by taking the scalar product of <a href="#eq-gc-euler-lagrange2" class="quarto-xref">Equation&nbsp;<span>26.36</span></a> with the effective magnetic field <span class="math inline">\(\mathbf{B}^\ast\)</span> <span id="eq-gc-u-time-derivative"><span class="math display">\[
\dot{u} = -\frac{\mathbf{B}^\ast}{m B_\parallel^\ast}\cdot\left( \nabla H_\text{gc} + \frac{e}{c}\frac{\partial\mathbf{A}^\ast}{\partial t} \right) \equiv \frac{e}{m}\frac{\mathbf{B}^\ast}{B_\parallel^\ast}\cdot\mathbf{E}^\ast
\tag{26.39}\]</span></span> with <span class="math inline">\(B_\parallel^\ast = \hat{b}\cdot\mathbf{B}^\ast\)</span> the effective magnetic field in the parallel direction.</p>
<p>The time derivative <a href="#eq-gc-u-time-derivative" class="quarto-xref">Equation&nbsp;<span>26.39</span></a> contains terms that are higher order (in gyroradius) compared with the dominant terms, which are all that is usually kept. These higher-order terms, however, are needed for energy conservation.</p>
<p>The guiding-center velocity <span class="math inline">\(\dot{\mathbf{X}}\)</span> comes from the vector product of <a href="#eq-gc-euler-lagrange2" class="quarto-xref">Equation&nbsp;<span>26.36</span></a> with <span class="math inline">\(\hat{b}\)</span> which, using <a href="#eq-gc-euler-lagrange1" class="quarto-xref">Equation&nbsp;<span>26.35</span></a>, yields <span id="eq-gc-X-time-derivative"><span class="math display">\[
\begin{aligned}
\dot{\mathbf{X}} &amp;= \frac{\mathbf{B}^\ast}{m B_\parallel^\ast}\frac{\partial H_\text{gc}}{\partial u} + \frac{c\hat{b}}{eB_\parallel^\ast}\times\left( \nabla H_\text{gc} + \frac{e}{c}\frac{\partial\mathbf{A}^\ast}{\partial t} \right) \\
&amp;= u\frac{\mathbf{B}^\ast}{B_\parallel^\ast} + \mathbf{E}^\ast\times\frac{c\hat{b}}{B_\parallel^\ast}
\end{aligned}
\tag{26.40}\]</span></span></p>
<p>If the effective fields <a href="#eq-gc-effective-em" class="quarto-xref">Equation&nbsp;<span>26.37</span></a> were replaced by the standard fields <span class="math inline">\((\mathbf{E},\mathbf{B})\)</span>, <a href="#eq-gc-u-time-derivative" class="quarto-xref">Equation&nbsp;<span>26.39</span></a> and <a href="#eq-gc-X-time-derivative" class="quarto-xref">Equation&nbsp;<span>26.40</span></a> would be the equations of motion for a particle in straight, constant EM fields.</p>
<p>The guiding-center equations of motion <a href="#eq-gc-u-time-derivative" class="quarto-xref">Equation&nbsp;<span>26.39</span></a> and <a href="#eq-gc-X-time-derivative" class="quarto-xref">Equation&nbsp;<span>26.40</span></a> can be used to derive the guiding-center energy equation <span id="eq-gc-energy-time-derivative"><span class="math display">\[
\frac{\mathrm{d}H_\text{gc}}{\mathrm{d}t} = \frac{\partial H_\text{gc}}{\partial t} + \dot{\mathbf{X}}\cdot\nabla H_\text{gc} + \dot{u}\frac{\partial H_\text{gc}}{\partial u} = e\frac{\partial\Phi^\ast}{\partial t} -\frac{e}{c}\frac{\partial\mathbf{A}^\ast}{\partial t}\cdot\dot{\mathbf{X}}
\tag{26.41}\]</span></span> which implies that the guiding-center energy <span class="math inline">\(E_\text{gc}\equiv mu^2/2+e\Phi^\ast\)</span> is a constant of the motion for time-independent fields.</p>
<p>An important remark must be made here concerning the polarization drift, which is absent from the guiding-center velocity <a href="#eq-gc-X-time-derivative" class="quarto-xref">Equation&nbsp;<span>26.40</span></a>. This drift, however, is critical for obtaining the dielectric response of a low-frequency plasma. Instead, it appears in the transformation <a href="#eq-gc-relation" class="quarto-xref">Equation&nbsp;<span>26.32</span></a> itself, i.e., the derivative of this relation gives <span id="eq-gc-relation-time-derivative"><span class="math display">\[
\dot{\mathbf{x}} = \dot{\mathbf{X}} + \dot{\tilde{\pmb{\rho}}} + \mathbf{v}_\text{pol}
\tag{26.42}\]</span></span> with <span id="eq-gc-polarization-v"><span class="math display">\[
\mathbf{v}_\text{pol} \equiv \frac{\mathrm{d}\bar{\pmb{\rho}}}{\mathrm{d}t}
\tag{26.43}\]</span></span> representing the polarization drift, and where <span class="math inline">\(\dot{\tilde{\pmb{\rho}}}=\dot{\zeta}\partial \tilde{\pmb{\rho}}/\partial \zeta + ...\)</span> consists of terms that oscillate on the gyroperiod time scale. The polarization drift is a pure derivative and, hence, can always be integrated. This implies, in particular, that <em>the polarization drift cannot lead to diffusion even in a turbulent field</em>. This is important, as the difference between the guiding center and the average location (found by dropping the second, oscillating term in <a href="#eq-gc-relation" class="quarto-xref">Equation&nbsp;<span>26.32</span></a>) is the polarization, the integral of the polarization drift. This difference must remain small or else the theory, which assumes that the particle remains close to <span class="math inline">\(\mathbf{X}\)</span>, would break down.</p>
<p>An alternate set of guiding-center equations of motion may be derived in which the polarization drift appears explicitly in the guiding-center velocity <span class="math inline">\(\dot{\mathbf{X}}\)</span> by choosing <span class="math inline">\(\bar{\pmb{\rho}}\equiv 0\)</span> instead of <a href="#eq-gc-gyroradius-bar" class="quarto-xref">Equation&nbsp;<span>26.33</span></a>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-cary2009hamiltonian" class="csl-entry" role="listitem">
Cary, John R, and Alain J Brizard. 2009. <span>“Hamiltonian Theory of Guiding-Center Motion.”</span> <em>Reviews of Modern Physics</em> 81 (2): 693. <a href="https://doi.org/10.1103/RevModPhys.81.693">https://doi.org/10.1103/RevModPhys.81.693</a>.
</div>
<div id="ref-mignone2023guiding" class="csl-entry" role="listitem">
Mignone, Andrea, H Haudemand, and E Puzzoni. 2023. <span>“A Guiding Center Implementation for Relativistic Particle Dynamics in the PLUTO Code.”</span> <em>Computer Physics Communications</em> 285: 108625. <a href="https://doi.org/10.1016/j.cpc.2022.108625">https://doi.org/10.1016/j.cpc.2022.108625</a>.
</div>
<div id="ref-northrop1963adiabatic" class="csl-entry" role="listitem">
Northrop, Theodore G. 1963. <span>“Adiabatic Charged-Particle Motion.”</span> <em>Reviews of Geophysics</em> 1 (3): 283–304. <a href="https://doi.org/10.1029/RG001i003p00283">https://doi.org/10.1029/RG001i003p00283</a>.
</div>
<div id="ref-northrop1960stability" class="csl-entry" role="listitem">
Northrop, Theodore G, and Edward Teller. 1960. <span>“Stability of the Adiabatic Motion of Charged Particles in the Earth’s Field.”</span> <em>Physical Review</em> 117 (1): 215. <a href="https://doi.org/10.1103/PhysRev.117.215">https://doi.org/10.1103/PhysRev.117.215</a>.
</div>
<div id="ref-vandervoort1960relativistic" class="csl-entry" role="listitem">
Vandervoort, Peter O. 1960. <span>“The Relativistic Motion of a Charged Particle in an Inhomogeneous Electromagnetic Field.”</span> <em>Annals of Physics</em> 10 (3): 401–53. <a href="https://doi.org/10.1016/0003-4916(60)90004-X">https://doi.org/10.1016/0003-4916(60)90004-X</a>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>For verification simply substitute <span class="math inline">\(x_\mu\)</span> and <span class="math inline">\(U_\mu\)</span> in the left and right-end side of <a href="#eq-charged-particle-motion-general" class="quarto-xref">Equation&nbsp;<span>26.1</span></a>, respectively, to find that <span class="math inline">\(F_{\mu\nu} U_\nu = 0\)</span>, and rewrite the indexes of such equation explicitly.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Notice that the <span class="math inline">\(\mathcal{L}()\)</span> operator is the Lagrangian derivative <span class="math inline">\(\mathrm{d}/\mathrm{d}t\)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../contents/aurora.html" class="pagination-link" aria-label="Aurora">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Aurora</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../contents/cr.html" class="pagination-link" aria-label="Cosmic Ray">
        <span class="nav-page-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Cosmic Ray</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/henry2004y/KeyNotes/edit/master/contents/gc.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>