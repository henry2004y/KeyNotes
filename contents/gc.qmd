# Guiding Center {#sec-GC}

The guiding center approximation (GCA) is a theoretical framework used to simplify the complex motion of charged particles in electromagnetic fields by separating the fast gyromotion from the slower drifts of the particle's guiding center (GC).

The basic equation governing the motion of a charged particle with mass m and charge e is given by
$$
\frac{\mathrm{d}\mathbf{u}}{\mathrm{d}t} = \frac{e}{mc}\left( c\mathbf{E} + \mathbf{v}\times\mathbf{B} \right)
$$
where $\mathbf{u}=\gamma\mathbf{v}$ represents the particle’s four-velocity, $\mathbf{v}$ is the particle velocity, c is the speed of light while $\mathbf{E}$ and $\mathbf{B}$ are the electric and magnetic field vectors, respectively.

In GCA, the orbital motion of the particle is detached from its instantaneous gyration center. This relaxes any constraints related to particle gyration, allowing systematic larger time steps to be taken and thus a considerable saving in computational time. The guiding center (GC) equations are obtained in the limit of slow-varying fields. This restricts its validity to situations in which the Larmor radius remains negligible with respect to the overall electromagnetic field scale and in which the cyclotron frequency is large enough so that adiabatic invariance holds. In this respect, the GCA is most suitable for particles with large charge-to-mass ratios such as electrons.

## Summarized Version

### Basic Concepts and Variables

**State Variables**: Instead of the full 6D phase space $(\mathbf{x}, \mathbf{v})$, we solve for the reduced 4D guiding center state:

- $\mathbf{X}$: The spatial position of the guiding center.
- $p_{\parallel} = m \gamma v_{\parallel}$: The relativistic kinetic momentum parallel to the magnetic field, where $\gamma$ is the Lorentz factor.

The position $\mathbf{r}$ of a particle is decomposed into the guiding center position $\mathbf{R}(t)$ and the gyration vector $\boldsymbol{\rho}$:
$$
\mathbf{r} = \mathbf{R}(t) + \boldsymbol{\rho}(\mathbf{R}, t, \psi)
$$
where $\psi$ is the gyrophase. This approximation holds when the characteristic scale of field variations $L$ is much larger than the Larmor radius $\rho$ ($L \gg \rho$) and time variations are slow compared to the gyroperiod.

**Parameters (Constant of Motion)**:

- $\mu$: The magnetic moment (adiabatic invariant).
$$
\mu = \frac{p_{\perp}^2}{2mB}
$$
In the GCA, $\mu$ is constant. It is calculated once from the initial conditions and treated as a parameter during the simulation.

### The Effective Fields

The modern GCA equations can be written compactly using "effective" electromagnetic fields $\mathbf{B}^*$ and $\mathbf{E}^*$. These correct the standard fields to account for drifts naturally.

Definitions:

- $\mathbf{B}(\mathbf{X})$ and $\mathbf{E}(\mathbf{X})$: Standard EM fields at the guiding center location.
- $\mathbf{b} = \mathbf{B}/|\mathbf{B}|$: Unit vector along the magnetic field line.
- $q$: Particle charge.

**Calculate the Effective Magnetic Field $\mathbf{B}^*$**

This term incorporates the geometry of the field lines (curl of $\mathbf{b}$) which drives curvature drift.
$$
\mathbf{B}^* = \mathbf{B} + \frac{c p_{\parallel}}{q} \nabla \times \mathbf{b}
$$

**Calculate the Effective Electric Field $\mathbf{E}^*$**

In many implementations, it is easier to work directly with the Hamiltonian gradients, but formally:
$$
\mathbf{E}^* = \mathbf{E} - \frac{1}{q} \nabla ( \mu B )
$$

### Hamiltonian

For a relativistic particle, the Hamiltonian $H$ represents the total energy.
$$
H(\mathbf{X}, p_{\parallel}, \mu, t) = \sqrt{m^2 c^4 + p_{\parallel}^2 c^2 + 2 m \mu B(\mathbf{X}) c^2} + q \Phi(\mathbf{X})
$$

- $\Phi$: Electric scalar potential (if $\mathbf{E} = -\nabla \Phi$).
- Note: If you only have $\mathbf{E}$ and not $\Phi$, you will use the force term $q E_{\parallel}$ directly in the equations of motion.

### Equations of Motion

These are the final expressions to solve numerically. They describe the time evolution of the guiding center position $\mathbf{X}$ and parallel momentum $p_{\parallel}$.

Equation for Position ($\dot{\mathbf{X}}$):
$$
\frac{d\mathbf{X}}{dt} = \frac{1}{B^*_{\parallel}} \left[ \frac{p_{\parallel}}{m \gamma} \mathbf{B}^* + c \mathbf{E}^* \times \mathbf{b} \right]
$$

- Term 1 ($\propto \mathbf{B}^\ast$): Represents motion along the field line plus curvature drift (hidden inside $\mathbf{B}^\ast$).
- Term 2 ($\propto \mathbf{E}^\ast \times \mathbf{b}$): Represents the $\mathbf{E} \times \mathbf{B}$ drift and the $\nabla B$ drift (hidden inside $\mathbf{E}^\ast$ via the $\mu \nabla B$ term).
- Denominator: $B^\ast_{\parallel} = \mathbf{b} \cdot \mathbf{B}^\ast \approx B$. This is a normalization factor essentially equal to $B$ but corrected for phase-space volume conservation.

Equation for Parallel Momentum ($\dot{p}_{\parallel}$):
$$
\frac{dp_{\parallel}}{dt} = \frac{q}{B^\ast_{\parallel}} \mathbf{B}^* \cdot \mathbf{E}^\ast
$$

This simplifies to the standard parallel force equation:
$$
\dot{p}_{\parallel} \approx q E_{\parallel} - \frac{\mu}{\gamma} \nabla_{\parallel} B
$$

### Numerical Implementation Guide

To implement this in code, follow this loop:

- A. Initialization
  1. Start with particle particle position $\mathbf{x}$ and velocity $\mathbf{v}$.
  2. Compute local $\mathbf{B}(\mathbf{x})$ and $\mathbf{b}$.
  3. Decompose velocity: $\mathbf{v} = v_{\parallel} \mathbf{b} + \mathbf{v}_{\perp}$.
  4. Compute $\mu = \frac{m \gamma^2 v_{\perp}^2}{2 B}$ (Relativistic moment).
  5. Initialize state vector $\mathbf{Y} = [\mathbf{X}, p_{\parallel}]$.
- B. Time Stepping Loop. For every time step $t \to t + \Delta t$:
  1. Interpolate Fields: Get $\mathbf{B}, \mathbf{E}, \nabla \mathbf{B}$ at current $\mathbf{X}$.
  2. Compute Gradients: You need $\nabla \times \mathbf{b}$ and $\nabla B$.
    - $\nabla \times \mathbf{b}$ can be computed numerically or analytically if the B-field model is known.
  3. Construct Effective Fields:
    - $\mathbf{B}^* = \mathbf{B} + \frac{c p_{\parallel}}{q} (\nabla \times \mathbf{b})$
    - $B^*_{\parallel} = \mathbf{b} \cdot \mathbf{B}^*$
  4. Evaluate Derivatives (RHS):
    - $\gamma = \sqrt{1 + \frac{p_{\parallel}^2 + 2m\mu B}{m^2 c^2}}$
    - $\dot{\mathbf{X}} = \frac{1}{B^*_{\parallel}} \left( \frac{p_{\parallel}}{m \gamma} \mathbf{B}^* + \frac{c}{q} (q\mathbf{E} - \mu \nabla B) \times \mathbf{b} \right)$
    - $\dot{p}_{\parallel} = \frac{q}{B^*_{\parallel}} \mathbf{B}^* \cdot \left( \mathbf{E} - \frac{\mu}{q} \nabla B \right)$
  5. Advance: Update $\mathbf{X}$ and $p_{\parallel}$.
- C. Constraints & Checks
  - Time Step: The GCA allows much larger time steps than full orbit codes because you don't resolve the gyro-period. However, you must resolve the gradient length scales. A common constraint is ensuring the particle does not cross more than one cell (or characteristic length) per step.
  - Validity: Check that $E_{\perp} < B$ and that the gyroradius is small compared to field gradients ($R_L \ll L_B$).

### Conversion from Full Phase Space to Guiding Center

Transforming from the full 6D particle state $(\mathbf{x}, \mathbf{v})$ to the reduced Guiding Center (GC) state $(\mathbf{X}, v_{\parallel}, \mu)$ is a surjective mapping (many particle states map to the same GC state).

To perform this switch consistently—especially in hybrid codes where you might switch back and forth—it is critical to match the constants of motion (like Energy) between the two frames.
Here is the step-by-step transformation procedure:

1. Calculate the Guiding Center Position ($\mathbf{X}$)

The guiding center is located at the center of the particle's gyration. You must calculate the Larmor radius vector at the particle's current position $\mathbf{x}$ and subtract it.

- Compute local field: Retrieve $\mathbf{B}(\mathbf{x})$ and the unit vector $\mathbf{b}(\mathbf{x}) = \mathbf{B}(\mathbf{x}) / |\mathbf{B}(\mathbf{x})|$.
- Compute displacement:
$$
\mathbf{X} \approx \mathbf{x} + \frac{m}{q B(\mathbf{x})} \mathbf{v} \times \mathbf{b}(\mathbf{x})
$$
  - This equation is valid to the first order in the Larmor radius.
  - It is recommended to perform this displacement in Cartesian coordinates to avoid singularities.

2. Update Fields at the New Position

Once you have the estimated guiding center position $\mathbf{X}$, you must evaluate the electromagnetic fields $\mathbf{B}(\mathbf{X})$, $\mathbf{E}(\mathbf{X})$ and potentials $\Phi(\mathbf{X})$ at this new location.

3. Calculate Parallel Velocity ($v_{\parallel}$)

The parallel velocity is defined relative to the magnetic field at the guiding center $\mathbf{X}$, not the particle position $\mathbf{x}$.

- Standard Projection:
$$
v_{\parallel} = \mathbf{v} \cdot \mathbf{b}(\mathbf{X})
$$
- Energy/Momentum Matching (High Precision): For higher accuracy, specifically to ensure that the particle's toroidal momentum $P_{\phi}$ is conserved during the switch (in axisymmetric systems), you can calculate $v_{\parallel}$ derived from the momentum conservation equation:
$$
v_{\parallel} \approx \frac{1}{B(\mathbf{X})} \left( \mathbf{v} \cdot \mathbf{B}(\mathbf{X}) + \dots \text{higher order terms} \right)
$$

For most standard implementations, the simple projection $\mathbf{v} \cdot \mathbf{b}(\mathbf{X})$ is sufficient.

4. Calculate Magnetic Moment ($\mu$)

The magnetic moment is the adiabatic invariant. It is crucial to calculate $\mu$ such that the total energy $\mathcal{H}$ of the particle is conserved during the transformation.

- Energy Conservation Condition:
$$
\mathcal{H}_{\text{particle}} = \mathcal{H}_{\text{GC}}
$$
$$
\frac{1}{2} m v^2 + q \Phi(\mathbf{x}) = \frac{1}{2} m v_{\parallel}^2 + \mu B(\mathbf{X}) + q \Phi(\mathbf{X})
$$
- Formula for $\mu$:
Rearranging the energy equation gives the most robust definition for $\mu$ during the switch:
$$\mu = \frac{1}{B(\mathbf{X})} \left[ \frac{1}{2} m v^2 - \frac{1}{2} m v_{\parallel}^2 + q(\Phi(\mathbf{x}) - \Phi(\mathbf{X})) \right]$$
  - If the electric potential variation $q(\Phi(\mathbf{x}) - \Phi(\mathbf{X}))$ is negligible (order of Larmor radius), this simplifies to the standard definition:
$$
\mu \approx \frac{m v_{\perp}^2}{2 B(\mathbf{X})}
$$
where $v_{\perp}^2 = v^2 - v_{\parallel}^2$.

Summary Algorithm
1. Input: Particle $\mathbf{x}, \mathbf{v}$.
2. Shift: $\mathbf{X} = \mathbf{x} + \frac{m}{q B(\mathbf{x})} (\mathbf{v} \times \mathbf{b})$.
3. Project: $v_{\parallel} = \mathbf{v} \cdot \mathbf{b}(\mathbf{X})$.
4. Conserve: $\mu = \frac{ \frac{1}{2}m v^2 - \frac{1}{2}m v_{\parallel}^2 }{B(\mathbf{X})}$ (ignoring potential differences).
5. Output: State $(\mathbf{X}, v_{\parallel}, \mu)$.

### Conversion from Guiding Center to Full Phase Space

Converting from the reduced Guiding Center (GC) variables $(\mathbf{X}, p_{\parallel}, \mu)$ back to the full 6D particle phase space $(\mathbf{x}, \mathbf{p})$ is a "one-to-many" mapping. Because the gyrophase $\zeta$ is averaged out in the GCA, you must arbitrarily choose (or randomly assign) a gyrophase angle $\zeta \in [0, 2\pi)$ to reconstruct a specific particle position and velocity.

Here is the step-by-step reconstruction procedure.

1. Calculate Local Quantities at the Guiding Center

First, evaluate the electromagnetic fields and unit vectors at the known guiding center position $\mathbf{X}$.
- Local Magnetic Field: $\mathbf{B} = \mathbf{B}(\mathbf{X})$
- Unit Vector: $\mathbf{b} = \mathbf{B} / |\mathbf{B}|$
- Perpendicular Momentum Magnitude: Calculate $p_{\perp}$ from the magnetic moment $\mu$ (which is a parameter in GCA):
$$
p_{\perp} = \sqrt{2 m B(\mathbf{X}) \mu}
$$
- Gyroradius Magnitude:
$$
\rho = \frac{p_{\perp}}{|q| B(\mathbf{X})}
$$

2. Define a Perpendicular Basis

To define the gyration direction, you need a coordinate system perpendicular to the magnetic field. Construct two unit vectors $\mathbf{e}_1$ and $\mathbf{e}_2$ such that $(\mathbf{e}_1, \mathbf{e}_2, \mathbf{b})$ form a right-handed orthonormal basis.

A common numerical method to find $\mathbf{e}_1$ is:
$$
\mathbf{e}_1 = \frac{\mathbf{b} \times \hat{\mathbf{u}}}{|\mathbf{b} \times \hat{\mathbf{u}}|}
$$
where $\hat{\mathbf{u}}$ is any fixed unit vector not parallel to $\mathbf{b}$, e.g., $\hat{\mathbf{x}}$. Then:
$$
\mathbf{e}_2 = \mathbf{b} \times \mathbf{e}_1
$$

3. Reconstruct Particle Position ($\mathbf{x}$)

The particle position is the guiding center position displaced by the Larmor radius vector $\boldsymbol{\rho}$. Select a gyrophase $\zeta$ (e.g., draw from a uniform distribution $U[0, 2\pi]$).
$$
\mathbf{x} = \mathbf{X} + \boldsymbol{\rho}
$$

The displacement vector $\boldsymbol{\rho}$ is:
$$
\boldsymbol{\rho} = \rho (\cos\zeta \, \mathbf{e}_1 + \sin\zeta \, \mathbf{e}_2)
$$

Note: In some high-precision hybrid schemes, specific choices for $\zeta$ (such as aligning $\boldsymbol{\rho}$ perpendicular to $\nabla B$) are used to minimize energy discrepancies when switching models, but for general reconstruction, a random phase is standard.

4. Reconstruct Particle Momentum ($\mathbf{p}$)

The total momentum is the sum of the parallel momentum, the perpendicular gyration momentum, and (optionally for higher accuracy) the momentum associated with the $\mathbf{E} \times \mathbf{B}$ drift.

**Standard Reconstruction (0th Order)**: This reconstruction creates a particle purely gyrating and moving parallel to field lines.
$$
\mathbf{p} = p_{\parallel} \mathbf{b} + \mathbf{p}_{gyro}
$$
where the gyration momentum $\mathbf{p}_{gyro}$ is perpendicular to $\boldsymbol{\rho}$ (tangent to the circle):
$$
\mathbf{p}_{gyro} = p_{\perp} (-\sin\zeta \, \mathbf{e}_1 + \cos\zeta \, \mathbf{e}_2) \times \text{sign}(q)
$$

**Drift-Corrected Reconstruction (1st Order)**: If the GCA simulation includes significant $\mathbf{E} \times \mathbf{B}$ drifts, we should add this component to the particle velocity to ensure the full orbit matches the drift path.
$$
\mathbf{p} \approx p_{\parallel} \mathbf{b} + \mathbf{p}_{gyro} + m \gamma \mathbf{v}_E
$$
where
$$
\mathbf{v}_E = \frac{c \mathbf{E} \times \mathbf{b}}{B}
$$


## Classical Guiding Center Theory

Here are the essentials points in the derivation of the classical _guiding center equations of motion (EOM)_. For a complete discussion refer to @vandervoort1960relativistic.

### Lorentz equation in tensor form

In order to derive the Guiding Center Approximation (GCA), we would use the tensor notations in relativity.
The equation of motion for a charged particle in an EM field are written in a tensorial form as
$$
\frac{\mathrm{d}x_\mu}{\mathrm{d}\tau^2} = F_{\mu\nu} \frac{\mathrm{d}x_\nu}{\mathrm{d}\tau}
$$ {#eq-charged-particle-motion-general}
where $x_\mu$ is the particle four-coordinate, $F_{\mu\nu}$ is the EM tensor and $\tau$ is the particle proper time.

The EM tensor is
$$
F_{\mu\nu} = \frac{e}{mc}
\begin{pmatrix}
0 & B_z & -B_y & E_x \\
-B_z & 0 & B_x & E_y \\
B_y & -B_x & 0 & E_z \\
E_x & E_y & E_z & 0
\end{pmatrix}
$$ {#eq-em-tensor}

### Fundamental assumptions

The GC formalism holds under two fundamental assumptions, namely:

1. The gyration radius must remain small compared to the scale length upon which the electromagnetic field changes significantly.
2. The particle undergoes many gyrations before the electromagnetic field changes appreciably (slowl-varying fields  pproximation). If we let $\rho$ be the particle gyroradius (apart from a factor √2), $x_\mu$ the particle position, $X_\mu$ the GC position, $\tau$ the proper time and $F_{\mu\nu}$ the EM field tensor, the two conditions stated above can be mathematically expressed as
$$
\rho \left| \frac{\partial F_{\mu\nu}}{\partial x_\alpha} \right| \ll \left| F_{\mu\nu} \right|
$$ {#eq-gca-condition1}
and
$$
\frac{1}{\omega} \left| \frac{\partial F_{\mu\nu}}{\partial x_\alpha} \right| \left| \frac{\mathbf{d}X_\beta}{\mathrm{d}\tau} \right| \ll \left| F_{\mu\nu} \right|
$$ {#eq-gca-condition2}
where $\omega$ is the gyrofrequency. When the previous conditions hold, we can separate the particle trajectory into a gyration and a motion of the guiding center.

### Derivations of GC equation

The general solution of @eq-charged-particle-motion-general is a linear combination of the two fundamental solutions related to the four EM tensor eigenvalues $q=\pm i\omega$ and $q=\pm\lambda$, where
$$
\begin{aligned}
\omega &= \frac{e}{mc}\sqrt{\frac{1}{2}(B^2 - E^2) + \frac{1}{2}\sqrt{(B^2 - E^2)^2 + 4(\mathbf{E}\cdot\mathbf{B})^2}} \\
\lambda &= \frac{e}{mc}\sqrt{-\frac{1}{2}(B^2 - E^2) + \frac{1}{2}\sqrt{(B^2 - E^2)^2 + 4(\mathbf{E}\cdot\mathbf{B})^2}}
\end{aligned}
$$ {#eq-EM-eigenvalues}

$\omega$ is a generalized relativistic form of the Larmor frequency $\omega_\xi = eB/(mc)$ in the case when $E\neq 0$ (which can be verified by solving in the limit $E\to 0$). The general solution $x_\mu$ of @eq-charged-particle-motion-general is
$$
x_\mu = \xi_\mu\rho \cos(\omega\tau) - \eta_\mu \rho \sin(\omega\tau) + \alpha_\mu \nu \cosh(\lambda\tau) + \beta_\mu \nu \sinh(\lambda\tau)
$$ {#eq-charged-particle-motion-general-sol}

Note that the first two terms are related to a periodic motion, that is the gyration around magnetic field lines with gyroradius $\rho$. Here $\rho, \nu$ are constants defined by the initial conditions and $\xi_\mu,\eta_\mu,\alpha_\mu$ and $\beta_\mu$ are four-versors normalized in the manner
$$
\xi_\mu^2 = \eta_\mu^2 = 1,\quad \text{and}\quad \alpha_\mu^2 = -\beta_\mu^2 = 1
$$ {#eq-charged-particle-motion-general-sol-normalization}

Solutions for $\rho = 0$ and $\nu = 0$ must be valid separately, so by replacing $x_\mu$ for these two particular cases inside @eq-charged-particle-motion-general we can see that $\xi_\mu,\eta_\mu,\alpha_\mu$ and $\beta_\mu$ form an orthogonal set of the Minkowsky space. The orthogonality relations between this set of four-vectors in particular states that the periodic motion (gyration) in the $(\xi_mu,\eta_\mu)$-plane is perpendicular to the acceleration motion in the $(\alpha_\mu, \beta_\mu)$-plane, and will be useful later. At this point, another useful relation is retrieved from the squared velocity invariance
$$
\frac{\mathrm{d}x_\mu}{\mathrm{d}\tau}\frac{\mathrm{d}x_\mu}{\mathrm{d}\tau} = -c^2,\quad\text{which leads to}\quad \omega^2\rho^2 - \lambda^2\nu^2 = -c^2
$$ {#eq-sqr-v-invariance}

Since we are only interested in cases in which gyration appears, the only singular eigenvalue case we must consider is the one with $\lambda=0, \omega\neq 0$, corresponding to $\mathbf{E}\cdot\mathbf{B}=0$ and $|\mathbf{E}|\to 0$. The associated solution is
$$
x_\mu = \xi_\mu\rho \cos(\omega\tau) - \eta_\mu \rho \sin(\omega\tau) + U_\mu \tau
$$ {#eq-associated-sol}

Here the gyration motion with Larmor frequency $\omega_\xi = \omega$ is clearly shown, along with a uniform motion (drift) with velocity $U_\mu = (\gamma c, \mathbf{U})$ in the plane perpendicular to the $(\mathbf{E}, \mathbf{B})$-plane.[^verification]
In this particular case, the squared velocity invariance @eq-sqr-v-invariance becomes
$$
\omega^2\rho^2 + U_\mu^2 = -c^2,\quad\text{or}\quad U_\mu^2 = -c^2 - \omega^2\rho^2 < -c^2
$$ {#eq-sqr-v-invariance1}

[^verification]: For verification simply substitute $x_\mu$ and $U_\mu$ in the left and right-end side of @eq-charged-particle-motion-general, respectively, to find that $F_{\mu\nu} U_\nu = 0$, and rewrite the indexes of such equation explicitly.

@eq-sqr-v-invariance1 is of crucial importance in the GCA formalism, because the drift motion $U_\mu$ is the mean motion separated from the gyration and corresponds to the GC motion itself, meaning that what we just found is a relation between the energy and momentum of a particle guiding center. It is very similar to the well-known formula of the squared four-velocity ${U_\mu^\prime}^2=-c^2$, the only difference being an additional term $\omega^2\rho^2$. This suggests interpreting the motion of the GC as the one of a particle located in the center of gyration, performing no gyration and possessing a squared four velocity as stated in @eq-sqr-v-invariance1, in agreement with part of the particle kinetic energy being stored in the gyration motion through the term $\omega^2\rho^2$. By separating the spatial and temporal parts of $U_\mu$ and rearranging some terms inside @eq-sqr-v-invariance1, we can get a relation for the GC Lorentz factor
$$
\gamma_\text{GC} = \sqrt{1+\frac{|\mathbf{U}|^2}{c^2} + \frac{\omega^2\rho^2}{c^2}} = \sqrt{1+\frac{\gamma^2|\mathbf{v}|^2}{c^2} + \frac{\omega^2\rho^2}{c^2}}
$$ {#eq-gc-gamma}

Although we only considered a limit case, the same equation can be proven to be generally valid in the GCA formalism.

We now want to isolate the gyration motion in a general case. This is done by separating the motion as follows:
$$
x_\mu = \xi_\mu x + \eta_\mu y + x_\mu^\prime + X_\mu
$$ {#eq-gc-separation-of-motion}
where $x_\mu$ is the space-time position of the particle and $X_\mu$ is the position of the guiding center. We associate two variables $x$ and $y$ to describe the periodic motion in the $(\xi, \eta)$-plane, and the term $x_\mu^\prime$ will account for the periodic motions which do not lie in the same plane. To more easily describe the gyration, we also choose a new pair of variables
$$
\zeta = \frac{1}{\sqrt{2}}\left( x+ iy \right)\quad\text{and}\quad \zeta^\ast = \frac{1}{\sqrt{2}}\left( x - iy \right)
$$ {#eq-gc-new-vars}
so that $\xi_\mu x + \eta_\mu y = \delta_\mu\zeta + \sigma_\mu\zeta^\ast$. The new variables will allow us to choose $\zeta_\mu$ and $\delta_\mu$ in a more convenient way and let some factor $e^{i\phi}$ account for the initial conditions of the problem. We rewrite the particle coordinate using @eq-gc-new-vars
$$
x_\mu = \delta_\mu\zeta + \sigma_\mu\zeta^\ast + x_\mu^\prime + X_\mu
$$ {#eq-eq-gc-new-vars2}

The next step is substituting this expression into @eq-charged-particle-motion-general and expand the second derivative, which leads to a lengthy expression containing eight unkowns: $\zeta,\zeta^\ast$, two components of $x_\mu$ (the condition with the $(\sigma, \delta)$-plane sets the other two), and four components of $X_\mu$.

The conditions for the GCA expressed in @eq-gca-condition2 implicitly contain a parameter of smallness $\epsilon =|u/\omega L|\ll 1$, where u is the typical particle four-velocity and L the scale length upon which the change in the EM fields $F_{\mu\nu}$ is comparable to $F_{\mu\nu}$ (slowly-varying fields approximation). This allows us to approximate $F_{\mu\nu}(x_\mu)$ (particle coordinate) by using a Taylor expansion about $X_\mu$ (the GC coordinate)
$$
\begin{aligned}
F_{\mu\nu}(x_\mu) =& F_{\mu\nu}(X_\mu) \\
&+ \frac{\partial F_{\mu\nu}}{\partial x_\xi}(\delta_\xi \zeta + \sigma_\xi \zeta^\ast) \\
&+ \frac{1}{2} \frac{\partial^2 F_{\mu\nu}}{\partial x_\xi\partial x_\pi}\left[ \delta_\xi\delta_\pi \zeta^2 + \sigma_\xi\sigma_\pi {\zeta^\ast}^2 + (\sigma_\xi \delta_\pi + \sigma_\pi \delta_\xi)|\zeta|^2 \right] \\
&+ \frac{\partial F_{\mu\nu}}{\partial x_\xi} x_\xi^\prime + ...
\end{aligned}
$$

We should now substitute $F_{\mu\nu}(x_\mu)$ inside @eq-charged-particle-motion-general using the new coordinates in order to get a quite long equation containing all quantities evaluated at the GC position $X_\mu$ up to 2nd−order, and group all 2nd−order terms on the right-end side as $G_\mu$
$$
\begin{aligned}
&\delta_\mu\frac{\mathrm{d}^2\zeta}{\mathrm{d}\tau^2} + \sigma_\mu\frac{\mathrm{d}^2\zeta^\ast}{\mathrm{d}\tau^2}+\left( i\omega\delta_\mu + 2\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} \right)\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} \\
&+\left( -i\omega\sigma_\mu + 2\frac{\mathrm{d}\sigma_\mu}{\mathrm{d}\tau} \right) \frac{\mathrm{d}\zeta^\ast}{\mathrm{d}\tau} + \frac{\mathrm{d}^2\delta_\mu}{\mathrm{d}\tau^2}\zeta + \frac{\mathrm{d}^2\sigma_\mu}{\mathrm{d}\tau^2}\zeta^\ast \\
&- \frac{\partial F_{\mu\nu}}{\partial x_\xi}\left( \delta_\xi \zeta + \sigma_\xi \zeta^\ast \right)\frac{\mathrm{d}X_\nu}{\mathrm{d}\tau} - F_{\mu\nu}\left( \frac{\mathrm{d}\delta_\nu}{\mathrm{d}\tau}\zeta + \frac{\mathrm{d}\sigma_\nu}{\mathrm{d}\tau}\zeta^\ast \right) \\
&- \frac{\partial F_{\mu\nu}}{\partial x_\xi}\left( \delta_\xi \zeta + \sigma_\xi \zeta^\ast \right) \left( \delta_\nu\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} + \sigma_\nu\frac{\mathrm{d}\zeta^\ast}{\mathrm{d}\tau} \right) \\
&+ \left( \frac{\mathrm{d}^2 X_\nu}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}X_\mu}{\mathrm{d}\tau} \right) + \left( \frac{d^2 x_\mu^\prime}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}x_\nu^\prime}{\mathrm{d}\tau} \right) = G_\mu
\end{aligned}
$$ {#eq-gc-expansion}

An expression for $\zeta$ is needed to further proceed, but since the derivation is quite long we will not explicitly derive it here. The basic idea is to use the orthogonality equations for the new four-vectors $\sigma_\mu$ and $\delta_\mu$ and the antisymmetry property of the EM tensor inside Maxwell's equations written in tensorial form, and then assume that a solution for $X_\mu$ has already been found. Considered that $x_\mu$ is a 1st−order term in the GCA, by ignoring 2nd−order quantities and writing terms independent from $\zeta$ as a numerical value $P$, then @eq-gc-expansion becomes
$$
\frac{\mathrm{d}^2\zeta}{\mathrm{d}\tau^2} + i\Omega\frac{\mathrm{d}\zeta}{\mathrm{d}\tau} + \frac{i}{2}\frac{\mathrm{d}\Omega}{\mathrm{d}\tau}\zeta + \Omega a \zeta + P = 0
$$ {#eq-gc-expansion2}
where $\Omega a \zeta$ contains all the linear terms in $\zeta$. Consequently, the corresponding solution $\zeta$, by analogy to the _Wentzel–Kramers–Brillouin (WKB)_ approximation in quantum mechanics, is
$$
\zeta = \rho_0 \sqrt{\frac{\omega_0}{\Omega}}\exp\left[ -i\left( \Phi + \int_{\tau_0}^\tau \sigma_1 \mathrm{d}\tau \right) \right]
$$ {#eq-gc-wkb}
to the 0th-order, being
$$
\Omega = \omega - 2i\sigma_\mu \frac{\mathrm{d}\delta_\mu}{\mathrm{d}\tau},\quad \Phi = \int_{\tau_0}^{\tau}\Omega\mathrm{d}\tau - \phi,\quad\text{and}\quad \sigma = a - \frac{a^2}{\Omega}
$$ {#eq-gc-wkb2}
The subscripts 0, 1 indicate the associated order of approximation for quantities defined above.

Since now we know the expression for $\zeta$, we can write the 1st−order EOM for $X_\mu$. For this purpose, we require that in the left-end side of @eq-gc-expansion the terms containing the 1st− and 2nd−order derivatives of $X_\mu$ are balanced by the remaining nonoscillatory terms, that is
$$
\frac{\mathrm{d}^2 X_\mu}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}X_\nu}{\mathrm{d}\tau} = \frac{\partial F_{\mu\nu}}{\partial x_\xi}\left( \delta_\xi \sigma_\nu \frac{\mathrm{d}\zeta^\ast}{\mathrm{d}\tau} + \delta_\nu \sigma_\xi \frac{\mathrm{d}\zeta}{\mathrm{d}\tau} \right)
$$ {#eq-gc-balance}

Having found the solution @eq-gc-wkb and making use once again of the orthogonality relations for $\delta_\mu$ and $\sigma_\mu$ and the tensorial Maxwell's equations, we can write the equation of motion for the GC
$$
\frac{\mathrm{d}^2 X_\mu}{\mathrm{d}\tau^2} - F_{\mu\nu}\frac{\mathrm{d}X_\nu}{\mathrm{d}\tau} + \rho_0^2 \omega_0\frac{\partial\omega}{\partial x_\mu} = 0
$$ {#eq-gc-eom}
where $\omega$ (@eq-EM-eigenvalues) is the generalized Larmor frequency, $\rho_0^2 \omega_0 = \mu_0 = mc\gamma^2 v_\perp^2 / 2eB$ is the 0th-order approximation (apart from a constant factor) to the particle magnetic moment $\mu$ and $\omega_0 = eB/(mc)$ represents the lowest-order approximation to the Larmor frequency in the case $E\ll B$.

More precisely, the magnetic moment should be regarded as constant only in the reference frame moving at $\mathbf{v}_E$, because in that particular case $\mathbf{E} = 0$. Indeed, a formal analysis (@northrop1960stability) shows that the corresponding constant of motion in a general reference frame is actually an asymptotic series expansion in a smallness parameter $\epsilon=u/(\omega_0 L)$ in the form $\mu = (e/c)\left[ \mu_0 + \epsilon \mu_1 + \epsilon^2 \mu_2 + ... \right]$ so that $\mu_0$ is not constant and can still vary in compliance with the adiabatic theory. Nevertheless, extensive numerical testing confirms that the
errors due to assuming $\mathrm{d}\mu_0 / \mathrm{d}t \approx 0$ are at most of the same order of those introduced by the GC formalism, as a consequence of the slowly varying field condition which prevents sensible changes in the magnetic moment. Hence, we safely assume that $\mu \approx (e/c)\mu_0$ is invariant.

### First order solution for the GCA equations of motion

Although deceitful simple, the GC equation of motion @eq-gc-eom is more conveniently cast in a form in which the GC velocity appears explicitly, under the nearly-crossed (EM) fields condition
$$
\frac{\mathbf{E}_\parallel \cdot\mathbf{B}}{B^2 - E_\perp^2} \ll 1
$$ {#eq-nearly-cross-em}
where the subscripts $\parallel$ and $\perp$ indicate the parallel and perpendicular components of the electric field with
respect to the magnetic field unit vector $\hat{b}$. It can be proven that @eq-nearly-cross-em allows the EM tensor field $F_{\mu\nu}$ to be split into a contribution $F_{\mu\ni}^{(0)}$ constructed solely from $\mathbf{E}_\perp$ and $\mathbf{B}$, plus a correction term $F_{\mu\nu}^{(1)}$ depending on $\mathbf{E}_\parallel$. A formal analysis leads to the conclusion that the GC four-velocity $U_\mu \equiv \mathrm{d}X_\mu/\mathrm{d}\tau$ can be decomposed into a 0th-order contribution $\mathrm{U}^{(0)}$ (which contains the drift velocity $\mathbf{v}_E = c\mathbf{E}_\perp \times\mathbf{B}/B^2$ as well as the velocity component parallel to the magnetic field line $v_\parallel \hat{b}$) plus 1st-order correction $\mathbf{U}^{(1)}$, leading to
$$
U_\mu = (\gamma c, \mathbf{U}) \simeq (\gamma c, \gamma v_\parallel \hat{b} + \gamma \mathbf{v}_E + \mathbf{U}^{(1)})
$$ {#eq-four-velocity-decomposition}
where $\gamma$ is the particle Lorentz factor $\gamma = (1- v^2/c^2)^{-1/2}$. An equation for $\mathbf{U}^{(1)}$ can be derived from @eq-gc-eom using a recursive approach as shown below, while from the spatial component one obtains an equation (to the same order) for the parallel component of the GC four-velocity $\gamma v_\parallel$. These yield the (1st-order) GCA system of ordinary differential equations (ODEs)
$$
\begin{aligned}
\frac{\mathrm{d}\mathbf{X}}{\mathrm{d}t} &= \mathbf{v}_E + v_\parallel \hat{b} + \frac{\gamma_E^2}{B}\hat{b}\times\left[ \frac{mc\gamma}{e}\left( v_\parallel\mathcal{L}(\hat{b}) + \mathcal{L}(\mathbf{v}_E) \right) + \mathcal{M}\left( \frac{B}{\gamma_E} \right) + \frac{v_\parallel E_\parallel}{c}\mathbf{v}_E \right] \\
\frac{\mathrm{d}(\gamma v_\parallel)}{\mathrm{d}t} &= \frac{e}{m}E_\parallel - \gamma\hat{b}\cdot\mathcal{L}(\mathbf{v}_E) - \frac{\mu}{\gamma m}\hat{b}\cdot\nabla\left(\frac{B}{\gamma_E}\right)
\end{aligned}
$$ {#eq-gc-eom-1st-sol}
where $\mathrm{d}\mathbf{X}/\mathrm{d}t = \mathbf{U}^{(1)}/\gamma$ represents the velocity of the guiding center, $e/m$ is the particle charge-to-mass ratio and $\mu_0 = c\mu/e$. The operators $\mathcal{L}$ and $\mathcal{M}$ are defined as
$$
\begin{aligned}
\mathcal{L}(x) &= \frac{\partial\mathbf{x}}{\partial t} + v_\parallel(\hat{b}\cdot\nabla)\mathbf{x} + (\mathbf{v}_E\cdot\nabla)\mathbf{x} \\
\mathcal{M}(x) &= \frac{\mu}{e\gamma}\left[ \frac{\mathbf{v}_E}{c}\frac{\partial x}{\partial t} + c\nabla x \right]
\end{aligned}
$$ {#eq-gc-eom-1st-operator}
where $\gamma_E = (1 - E_\perp^2/B^2)^{-1/2}$ is the Lorentz factor associated to the drift velocity $\mathbf{v}_E$.

In the GCA @eq-gc-eom-1st-sol information about motion perpendicular to the magnetic field is lost and the only component of the particle velocity that is actually evolved in time is $u_\parallel$, because the magnetic moment $\mu_0\approx c\mu/e$ is now considered a constant of motion. Each term on the right hand side of @eq-gc-eom-1st-sol corresponds to a specific drift motion. Indeed, the first term represents the $\mathbf{E}\times\mathbf{B}$ perpendicular drift, while the second one accounts for particle motion in the direction parallel to magnetic field. The first two terms in square bracket, $\mathcal{L}(\hat{b})$ and $\mathcal{L}(\mathbf{v}_E)$, describe the field curvature and polarization drifts[^L-lagrangian], respectively. The next term is the $\nabla-B$ drift, while the last one represents a relativistic drift in the direction given by $\hat{b}\times\mathbf{v}_E$.

[^L-lagrangian]: Notice that the $\mathcal{L}()$ operator is the Lagrangian derivative $\mathrm{d}/\mathrm{d}t$.

@eq-gc-eom-1st-sol lose their validity when either $B\to 0$ (magnetic null) or $E_\perp \ge B$, i.e. when the nearly-crossed EM fields condition, @eq-nearly-cross-em, is violated. While the first condition can easily occur inside a current sheet, the second may occur in a non-ideal MHD regime only. Violation of either condition breaks down the GCA and can lead to severe numerical errors.

### Recursive solution

An explicit solution for @eq-gc-eom can be found under @eq-nearly-cross-em, which introduces a new parameter of smallness $\lambda / \omega \ll 1$.

### Energy conservation

The time component of @eq-gc-eom leads to an evolutionary ODE for the particle energy as a function of time, namely
$$
\frac{\mathrm{d}\gamma c^2}{\mathrm{d}t} = \frac{e}{m}\frac{\mathrm{d}\mathbf{X}}{\mathrm{d}t}\cdot\mathbf{E} + \frac{\mu}{m}\frac{\partial}{\partial t}\left( \frac{B}{\gamma_E} \right)
$$ {#eq-gc-eom-time}

In the time-independent case, @eq-gc-eom-time clearly shows that, when the GC velocity is perpendicular to the electric field, no acceleration occurs and the particle energy is conserved. For numerical purposes, however, @eq-gc-eom-time is not solved for retrieving the Lorentz $\gamma$-factor, since large values of the right hand side could easily violate the condition $\gamma\ge 1$ at the truncation level of the scheme, unless small time steps are taken. In practice, to an 1st-order approximation, the particle velocity can be decomposed into a parallel component $v_\parallel$, a drift component $v_E$ and a gyration component $v_\perp$. This leads to the normalization condition
$$
\gamma^2( c^2 - v_\parallel^2 - v_\perp^2 - v_E^2) = c^2 
$$ {#eq-gc-eom-normalization-1st}

From the definition of the magnetic moment and the Larmor frequency $\mu_0 = mc\gamma^2 v_\perp^2/(2eB) = \gamma^2 v_\perp^2/(2\omega_0)$, we compute the particle Lorentz factor as
$$
\gamma = \sqrt{\frac{c^2 + \gamma^2 v_\parallel^2 + 2\mu_0 \omega_0}{c^2 - v_E^2}}
$$ {#eq-gc-eom-lorentz}

@eq-gc-eom-lorentz replaces @eq-gc-eom-time in common numerical solvers to get the Lorentz factor.

## Validity and Higher-Order Corrections

The standard guiding center approximation is a first-order expansion in the Larmor radius $\rho_L$. Its validity depends on the variation of the magnetic field being small across the gyroradius. A rigorous criterion requires analyzing the tensor of field derivatives:
$$
\frac{\sqrt{\lambda_{max}} \rho_\perp}{B} \ll 1
$$
where $\lambda_{max}$ is the maximum eigenvalue of the tensor involving gradients, curvature, and shearing of the field lines.

When field variations are strong (e.g., near sharp field reversals or current sheets), first-order approximations fail. Higher-order corrections (such as the Baños drift) may be required, which add terms proportional to the parallel curl of the magnetic field:
$$
\langle \dot{z} \rangle - \langle v_\parallel \rangle \approx \frac{\mu B}{m \omega_0} \hat{b} \cdot (\nabla \times \hat{b})
$$
This correction accounts for the discrepancy between the average particle velocity and the guiding center velocity due to field line shearing.

### Numerical implementation

The GCA @eq-gc-eom-1st-sol contains a set of 4 ODEs with unknowns $(\mathbf{X}, u_\parallel)$. The terms which require evaluation at grids are

* $\mathbf{B}$
* $c\mathbf{E}$
* $(\hat{b}\cdot\nabla)\hat{b}$
* $(\hat{b}\cdot\nabla)\mathbf{v}_E$
* $(\mathbf{v}_E\cdot\nabla)\mathbf{v}_E$
* $(\mathbf{v}_E\cdot\nabla)\hat{b}$
* $\nabla(B/\gamma_E)$

@mignone2023guiding reports the implementation of GCA in the PLUTO MHD model.

### Nonrelativistic case

In the nonrelativistic case, $\gamma = 1$ so we don't need to solve @eq-gc-eom-lorentz. @eq-gc-eom-1st-sol can be simplified into
$$
\begin{aligned}
\frac{\mathrm{d}\mathbf{X}}{\mathrm{d}t} &=  \\
\frac{\mathrm{d}(v_\parallel)}{\mathrm{d}t} &= 
\end{aligned}
$$ {#eq-gc-eom-1st-sol-nonrelativistic}

## Hamiltonian Theory of Guiding Center Motion

Following the review by @cary2009hamiltonian.

Canonical and noncanonical Hamiltonian formulations of guiding-center motion offer improvements over non-Hamiltonian formulations: Hamiltonian formulations possess Noether’s theorem (hence invariants follow from symmetries), and they preserve the Poincaré invariants (so that spurious attractors are prevented from appearing in simulations of guiding-center dynamics). Hamiltonian guiding-center theory is guaranteed to have an energy conservation law for time-independent fields—something that is not true of non-Hamiltonian guiding-center theories. The use of the phase-space Lagrangian approach facilitates this development, as there is no need to transform a priori to canonical coordinates, such as flux coordinates, which have less physical meaning.

### Noncanonical Hamiltonian guiding center theory

The guiding-center phase space consists of

* the guiding-center position $\mathbf{X}$, essentially the center of the helix;
* the guiding-center parallel velocity variable $u\equiv \hat{b}\cdot\dot{\mathbf{X}}$;
* the (lowest-order) magnetic moment,
$$
\mu \equiv \frac{m |\mathbf{w}|^2}{2B(\mathbf{X}, t)}
$$ {#eq-magnetic-moment-lowest-order-gc}
where $\mathbf{w} = \mathbf{v}_\perp - \mathbf{v}_E$ is the perpendicular velocity in the local frame moving with the $\mathbf{E}\times\mathbf{B}$ drift velocity $\mathbf{v}_E\equiv c\mathbf{E}\times\hat{b}/B$.

* and the ignorable gyrophase $\zeta$, which gives the location of the particle on the circle about the guiding center.

As there are still six variables parametrizing phase space, there is no loss of information in making the guiding-center transformation $(\mathbf{x},\mathbf{v}) \to (\mathbf{X},u,\mu,\zeta)$. For the sake of simplicity of notation, we occasionally
use the gyroaction variable $J \equiv mc/e\mu$ instead of the magnetic moment $\mu$ whenever we need to refer to the action-angle coordinates $J,\zeta$ associated with gyromotion.

The equations of motion for these variables are given by the guiding-center phase-space Lagrangian,
$$
\mathcal{L}_\text{gc}(\mathbf{X},u,\mu,\zeta;t) = \left[ \frac{e}{c}\mathbf{A}(\mathbf{X},t) + mu\hat{b}(\mathbf{X},t) \right]\cdot\dot{\mathbf{X}} + J\dot{\zeta} - H_\text{gc}
$$ {#eq-gc-lagrangian}
in which the guiding-center Hamiltonian is given by
$$
H_\text{gc}(\mathbf{X},u,\mu;t) = \frac{m}{2}u^2 + \mu B(\mathbf{X},t) + e\phi(\mathbf{X},t) - \frac{m}{2}\left| \mathbf{v}_E \right|^2
$$ {#eq-gc-hamiltonian}

The arguments are shown here to emphasize that, for example, the magnetic-field strength $B(\mathbf{X},t)$ is evaluated at the guiding-center position $\mathbf{X}$, not at the particle position $\mathbf{x}$. Here and throughout, the effects of a gravitational field may by found by adding the gravitational $m\Phi_G$ to the electrostatic potential energy $e\Phi$. In addition, we now drop the adjective phase space, as the guiding-center Lagrangian is always henceforth a phase-space Lagrangian.

The guiding-center Lagrangian @eq-gc-lagrangian comes not simply from gyrophase averaging, but from a transformation
from the physical (particle) variables $(\mathbf{x},\mathbf{v})$ to the guiding-center variables $(\mathbf{X},u,\mu,\zeta)$.
The relation between the physical location $\mathbf{x}$ and the guiding-center position $\mathbf{X}$ is
$$
\mathbf{x} \equiv \mathbf{X} + \pmb{\rho}
$$ {#eq-gc-relation}
where $\pmb{\rho}$ denotes the gyroradius displacement vector in the frame drifting with $\mathbf{v}_E$. Here we simply note that the displacement vector $\pmb{\rho}\equiv \tilde{\pmb{\rho}} + \bar{\pmb{\rho}}$ has a part (denoted by tilde) that is explicitly gyrophase dependent and a part (denoted by bar) that is gyrophase independent. In what follows, we show that the latter part
$$
\bar{\pmb{\rho}} = \frac{\hat{b}}{\Omega}\times\mathbf{v}_E = \frac{c\mathbf{E}_\perp}{\Omega B}
$$ {#eq-gc-gyroradius-bar}
denotes the guiding-center polarization displacement (Kaufman,  Phys. Fluids, 1986). ...

Our guiding-center Lagrangian @eq-gc-lagrangian is obtained from an ordering in which the scalar potential $\Phi$ is one order
lower than the particle kinetic energy, unlike previous derivations of the Hamiltonian theory of guiding-center motion. In this ordering, the electric drift $\mathbf{v}_E$ is of the same order as the perpendicular velocity $\mathbf{w}$, as in some non-Hamiltonian calculations (@northrop1963adiabatic). As we will see, this ordering allows us to obtain the polarization drift in the same order as the curvature and $\nabla B$ drifts, although it appears differently in the theory. However, for consistency the parallel electric field $E_\parallel = \mathbf{E}\cdot\hat{b}$ must be smaller by one order than the perpendicular field $\mathbf{E}_\perp$ (@eq-nearly-cross-em).

The variables $(J,\zeta)$ appear in canonical form in the symplectic part of the guiding-center Lagrangian @eq-gc-lagrangian as $J\dot{\zeta}$ while the guiding-center Hamiltonian $H_\text{gc}$ depends on $J$ (or $\mu$) alone. The Hamilton equations for $(J,\zeta)$ are
$$
\begin{aligned}
\dot{J} &= -\frac{\partial H_\text{gc}}{\partial \zeta} \equiv 0 \\
\dot{\zeta} &= \frac{\partial H_\text{gc}}{\partial J} \equiv \Omega
\end{aligned}
$$ {#eq-gc-hamilton-J-zeta}

@eq-gc-hamilton-J-zeta shows that the gyroaction (or magnetic moment) is conserved by the guiding-center equations of motion. This also follows from Noether’s theorem since the gyrophase $\zeta$ is an ignorable coordinate, i.e., only its time derivative appears in the guiding-center Lagrangian @eq-gc-lagrangian.

If one is concerned with only the motion of the guiding center and not the evolution of the gyrophase, the term linear in $\dot{\zeta}$ can be dropped from the guiding-center Lagrangian, as it does not affect the equations of motion of the other variables, $\mathbf{X}$ and $u$. In the evolution equations for $\mathbf{X}$ and $u$, the adiabatic invariant $\mu$ (or $J$) does appear but only as a guiding-center dynamical parameter.

Variation of the guiding-center Lagrangian @eq-gc-lagrangian with respect to the variable $u$ gives the Euler-Lagrange equation
$$
0 = \frac{\partial\mathcal{L}}{\partial u} = m\hat{b}\cdot\dot{\mathbf{X}} - \frac{\partial H_\text{gc}}{\partial u}
$$
which yields
$$
u \equiv \hat{b}\cdot\dot{\mathbf{X}}
$$ {#eq-gc-euler-lagrange1}

Thus, the guiding-center Lagrangian @eq-gc-lagrangian dictates that $u$ is the velocity of the guiding center in the direction of
the magnetic field at the guiding center.

Last, we vary the Lagrangian @eq-gc-lagrangian with respect to the guiding-center position $\mathbf{X}$, and obtain the Euler-Lagrange equation
$$
\begin{aligned}
m\dot{u}\hat{b} =& e\mathbf{E} - \mu\nabla B + \frac{m}{2}\nabla |\mathbf{v}_E|^2 - mu\frac{\partial\hat{b}}{\partial t} \\
& + \dot{\mathbf{X}}\times\left( \frac{e}{c}\mathbf{B}+mu\nabla\times\hat{b} \right) \\
\equiv& e\left( \mathbf{E}^\ast + \frac{1}{c}\dot{\mathbf{X}}\times\mathbf{B}^\ast \right)
\end{aligned}
$$ {#eq-gc-euler-lagrange2}
where the _effective_ EM fields
$$
\mathbf{E}^\ast \equiv -\nabla\Phi^\ast - \frac{1}{c}\frac{\partial\mathbf{A}^\ast}{\partial t}\quad\text{and}\quad \mathbf{B}^\ast \equiv\nabla\times\mathbf{A}^\ast
$$ {#eq-gc-effective-em}
are defined in terms of the effective EM potentials
$$
\begin{aligned}
e\Phi^\ast &\equiv e\Phi + \mu B -\frac{m}{2}|\mathbf{v}_E|^2 \\
\mathbf{A}^\ast &\equiv \mathbf{A} + \frac{mc}{e}u\hat{b}
\end{aligned}
$$ {#eq-gc-effective-em-potentials}

The guiding-center canonical momentum is now simply expressed as $e\mathbf{A}^\ast /c$ and the guiding-center Hamiltonian is $e\Phi^\ast + mu^2/2$.

We obtain the rate of change of the variable $u$ by taking the scalar product of @eq-gc-euler-lagrange2 with the effective magnetic field $\mathbf{B}^\ast$
$$
\dot{u} = -\frac{\mathbf{B}^\ast}{m B_\parallel^\ast}\cdot\left( \nabla H_\text{gc} + \frac{e}{c}\frac{\partial\mathbf{A}^\ast}{\partial t} \right) \equiv \frac{e}{m}\frac{\mathbf{B}^\ast}{B_\parallel^\ast}\cdot\mathbf{E}^\ast
$$ {#eq-gc-u-time-derivative}
with $B_\parallel^\ast = \hat{b}\cdot\mathbf{B}^\ast$ the effective magnetic field in the parallel direction.

The time derivative @eq-gc-u-time-derivative contains terms that are higher order (in gyroradius) compared with the dominant
terms, which are all that is usually kept. These higher-order terms, however, are needed for energy conservation.

The guiding-center velocity $\dot{\mathbf{X}}$ comes from the vector product of @eq-gc-euler-lagrange2 with $\hat{b}$ which, using @eq-gc-euler-lagrange1, yields
$$
\begin{aligned}
\dot{\mathbf{X}} &= \frac{\mathbf{B}^\ast}{m B_\parallel^\ast}\frac{\partial H_\text{gc}}{\partial u} + \frac{c\hat{b}}{eB_\parallel^\ast}\times\left( \nabla H_\text{gc} + \frac{e}{c}\frac{\partial\mathbf{A}^\ast}{\partial t} \right) \\
&= u\frac{\mathbf{B}^\ast}{B_\parallel^\ast} + \mathbf{E}^\ast\times\frac{c\hat{b}}{B_\parallel^\ast}
\end{aligned}
$$ {#eq-gc-X-time-derivative}

If the effective fields @eq-gc-effective-em were replaced by the standard fields $(\mathbf{E},\mathbf{B})$, @eq-gc-u-time-derivative and @eq-gc-X-time-derivative would be the equations of motion for a particle in straight, constant EM fields.

The guiding-center equations of motion @eq-gc-u-time-derivative and @eq-gc-X-time-derivative can be used to derive the guiding-center energy equation
$$
\frac{\mathrm{d}H_\text{gc}}{\mathrm{d}t} = \frac{\partial H_\text{gc}}{\partial t} + \dot{\mathbf{X}}\cdot\nabla H_\text{gc} + \dot{u}\frac{\partial H_\text{gc}}{\partial u} = e\frac{\partial\Phi^\ast}{\partial t} -\frac{e}{c}\frac{\partial\mathbf{A}^\ast}{\partial t}\cdot\dot{\mathbf{X}}
$$ {#eq-gc-energy-time-derivative}
which implies that the guiding-center energy $E_\text{gc}\equiv mu^2/2+e\Phi^\ast$ is a constant of the motion for time-independent fields.

An important remark must be made here concerning the polarization drift, which is absent from the guiding-center velocity @eq-gc-X-time-derivative. This drift, however, is critical for obtaining the dielectric response of a low-frequency plasma. Instead, it appears in the transformation @eq-gc-relation itself, i.e., the derivative of this relation gives
$$
\dot{\mathbf{x}} = \dot{\mathbf{X}} + \dot{\tilde{\pmb{\rho}}} + \mathbf{v}_\text{pol}
$$ {#eq-gc-relation-time-derivative}
with
$$
\mathbf{v}_\text{pol} \equiv \frac{\mathrm{d}\bar{\pmb{\rho}}}{\mathrm{d}t}
$$ {#eq-gc-polarization-v}
representing the polarization drift, and where $\dot{\tilde{\pmb{\rho}}}=\dot{\zeta}\partial \tilde{\pmb{\rho}}/\partial \zeta + ...$ consists of terms that oscillate on the gyroperiod time scale. The polarization drift is a pure derivative and, hence, can
always be integrated. This implies, in particular, that _the polarization drift cannot lead to diffusion even in a turbulent field_. This is important, as the difference between the guiding center and the average location (found by dropping the second, oscillating term in @eq-gc-relation) is the polarization, the integral of the polarization drift. This difference must remain small or else the theory, which assumes that the particle remains close to $\mathbf{X}$, would break down.

An alternate set of guiding-center equations of motion may be derived in which the polarization drift appears explicitly in the guiding-center velocity $\dot{\mathbf{X}}$ by choosing $\bar{\pmb{\rho}}\equiv 0$ instead of @eq-gc-gyroradius-bar.
